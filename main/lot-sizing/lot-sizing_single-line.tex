%!TEX root=../../thesis_ESG.tex
\chapter{Production on a single line}
\label{chap:lot-size:single-line}


As explained in \cref{sec:business-context:argon:pdp}, the objective is to reduce cumulative inventory.
This chapter presents a model whose aims at deciding the optimal cycle stocks.



\section{Motivations}
\label{sec:lot-size:single-line:motivations}

Cycle stocks form the portion of inventory that varies over time due to production and demand satisfaction.
Low cycle stocks contribute to globally decrease inventory but it requires a high flexibility of means of production.
For mid-term decisions, flexibility is already fixed and industrial aims at deciding the values of cycle stocks of each item which minimize the global inventory.


Many production systems are managed using $(r,\lot)$ policies or similar ones.
This kind of policies defines for each item a level $r$ and a quantity $\lot$ such that: when inventory level of item reaches level $r$, a quantity $\lot$ is produced.
A common variation uses cover-sizes.
Quantity $\lot$ is replaced by a time $\cover$ called \emph{cover-size}.
When inventory level of item $i$ reaches level $r$, quantity produced is the cumulative demand of the $\cover$ next units of time.
Both are used by industrials (and are equivalent when demand does not depend on time).


\section{Deterministic settings}
\label{sec:lot-size:single-line:deterministic}

In this whole section, data are assumed to be deterministic.


\subsection{Problem}
\label{sec:lot-size:single-line:deterministic:problems}

The problem described by Argon Consulting considers an assembly line producing a set $\REF$ of items over an infinite horizon.
%The capacity needed (in time units) to produce one unit of item $i$ is $\rate_i$.
The internal production time of item $i$ (\ie the quantity of item $i$ produced in one time unit) is $\rate_i$.
Inventory $\inventory_i$ of item $i$ must satisfy demand, known in advance.
Thus, it continuously decreases by $\demand_i<\rate_i$ units per time unit when there is no production and continuously increases by $\rate_i-\demand_i$ units per time unit when item $i$ is produced.


%We call \emph{order of production} of an item $i$ an interval of time $[t_1,t_2]$ dedicated to the production of $i$ such that $t_1<t_2$ production starts at $t_1$ and stops at $t_2$.
We call \emph{order of production} of an item $i$ a pair $\bracket{t_i,\theta_i}$ such that production of item $i$ starts at $t$ and lasts $\theta_i$ units of time.
We call \emph{production setup} or simply \emph{setup} the beginning of an order of production.
Orders of production of item $i$ can be placed at any time, even simultaneously (like in~\cite{Ohno2001} where authors assume the immediate replenishment of the order with lead time).
However, the cover $\cover_i$ of a given item $i$ has to be the same over the infinite horizon.
By definition of the cover, a solution is entirely defined by a sequence $\bracket{t_i,\cover_i}_{i\in\REF}$ where $t_i$ is the first setup of item $i$ and $\cover_i>0$ is the cover of item $i$.
Indeed, we directly obtain the duration $\theta_i=\frac{\demand_i}{\rate_i}\cover_i$ and the start $t_i+k\cover_i$ ($k\in\ZZ_+$) of each order of production of item $i$.

Thus, for each item $i$, inventory $\inventory_i\bracket{t}$ is nonnegative and follows the dynamic
\begin{equation}\label{eq:lot-size:single-line:deterministic:motivations:dynamic}
  \dot{\inventory}_i\bracket{t} =
  \left\{
  \begin{array}{ll}
  \rate_i-\demand_i
  & \ds\mbox{if}\ t\in\bigcup_{k\in\ZZ_+} \left[t_i+k\cover_i,t_i+\bracket{k+\frac{\demand_i}{\rate_i}}\cover_i\right),
  \\
  -\demand_i
  & \mbox{otherwise}.
  \end{array}
  \right.
\end{equation}
\esgil{Ajouter figure en dans de scie avec un dÃ©calage vers le haut et un stock initial.}

%(It imposes that the solution is periodic for each item.)
The flexibility being modeled by a constraint and not by setup costs (see \cref{sec:business-context:argon:pdp}), in average over the infinite horizon, the number of setups per unit time for all items must be lower than $\nbsetups$ which can be written as
\begin{equation}\label{eq:lot-size:single-line:deterministic:motivations:flexibility}
  \limsup_{\horizon\rightarrow+\infty}\ \frac{1}{\horizon} \sum_{i\in\REF} \left\lfloor\frac{\horizon-t_i}{\cover_i}\right\rfloor \le \nbsetups.
\end{equation}


For each item $i$, there is an initial inventory $\inventory_i\bracket{0}\in\RR_+$ given in input.


Since inventory varies over times, the cycle stock is measured using its average value over an infinite horizon.
Storing one unit of item $i$ incurs a unit holding cost $\holding_i>0$ per unit time.
Objective is to find the covers which minimize the average cycle stock over infinite horizon
\begin{equation}
  \limsup_{\horizon\rightarrow+\infty}\ \frac{1}{\horizon} \sum_{i\in\REF} \holding_i \int_0^{\horizon}\inventory_i\bracket{t}dt
\end{equation}
while satisfying positive inventory, constraint~\eqref{eq:lot-size:single-line:deterministic:motivations:dynamic} and constraint~\eqref{eq:lot-size:single-line:deterministic:motivations:flexibility}.

% The problem can be written as
% \begin{subequations}\label{eq:lot-size:single-line:deterministic}
%   \begin{align}
%   \min\quad & \ds \lim_{\horizon\rightarrow+\infty} \frac{1}{\horizon} \sum_{i\in\REF} \holding_i \int_0^{\horizon}\inventory_i\bracket{t}dt
%   \label{eq:lot-size:single-line:deterministic:unconstrained}
%   \\
%   \st\quad  & \ds \lim_{\horizon\rightarrow+\infty} \frac{1}{\horizon} \sum_{i\in\REF} \left\lfloor\frac{\horizon-t_i}{\cover_i}\right\rfloor \le \nbsetups
%   \label{eq:lot-size:single-line:deterministic:unconstrained}
%   \\
%   & \dot{\inventory}_i\bracket{t} =
%   \left\{
%   \begin{array}{ll}
%   \rate_i-\demand_i & \ds\mbox{if}\ t\in\bigcup_{k\in\ZZ_+} \left[t_i+k\cover_i,t_i+\bracket{k+\frac{\demand_i}{\rate_i}}\cover_i\right)
%   \\
%   -\demand_i & \mbox{otherwise}
%   \end{array}
%   \right.
%   && \forall i\in\REF,\ \forall t\in\RR_+,
%   \\
%   & \inventory_i\bracket{t} \ge 0 && \forall i\in\REF,\ \forall t\in\RR_+,
%   \\
%   & t_i \ge 0 && \forall i\in\REF,
%   \\
%   & \cover_i > 0 && \forall i\in\REF.
%   \label{eq:lot-size:single-line:deterministic:unconstrained}
%   \end{align}
% \end{subequations}


\medskip


Since this model is a variation of the \emph{Economic Production Quantity model (EPQ)}, we call it \emph{Economic Production Quantity model with Bounded number of Setups (EPQ-BS)}.
We will consider two versions of this problem:
\begin{itemize}
  \item the covers can be any nonnegative real numbers,
  \item the covers have to be inverses of integers.
\end{itemize}
In other words, since a cover is a time period, the production frequencies are unconstrained in the first version, while there are constrained to be integers in the second one.
We qualify the first version of being {\em unconstrained} and the second of being {\em integer}.


Integer version relies on practical reasons.
For decision makers, it is sometimes easier to use frequencies and thus to know that an item is produced once a month, twice a month, etc.



\subsection{Bibliography}

\textbf{literature review}

\begin{itemize}
   \item \cite{Gayon2016} Continuous-review inventory models for single item
\end{itemize} 

Multi-item

\begin{itemize}
  \item \cite{Hadley1963} first to note that perhaps the most important real world constraints are budget restrictions on the amount that can be invested in inventory.
  \item \cite{Schrady1971} Minimization of total time-weighted shortage subject to inventory investment (holding cost) and to reorder workload.
  They use our formula to find a solution but does not prove it optimality.
  \item \cite{Daeschner1975} Model with limited number of reorder transactions to be considered in the present allocation.
  \item \cite{Ohno2001} Minimization of the holding cost, backorder cost and ordering cost subject to capacity constraints on the inventory.
\end{itemize}


\medskip

\textbf{Ordering}

\begin{itemize}
  \item \cite{Harris1913} Economic Order Quantity (in French: ``Formule de Wilson'' because it was extensively used by R. H. Wilson from 1934)
  \begin{itemize}
    \item single item
    \item cost structure: proportional holding cost, variable and fixed order cost
    \item stationary demand $\demand$
    \item average cost over infinite horizon
  \end{itemize}
  \item Time varying demand $\demand(t)$
  \begin{itemize}
    \item \cite{Resh1976,Donaldson1977} $\demand(t)=\alpha t+\gamma$ polynomial
    \item \cite{Barbosa1978} $\demand(t)=\alpha t^{\beta}$
    \item difficult in general
  \end{itemize}
\end{itemize}

Classical policy: Zero Inventory Ordering policy $(r,q)$ (Order quantity $q$ when current inventory is $r$)

\medskip

\textbf{Production}

\begin{itemize}
  \item Economic Production Quantity (extension of EOQ with limited production capacity) \cite{Taft1918}
  \begin{itemize}
    \item Limited production capacity
  \end{itemize}
\end{itemize}


\medskip

\esgil{complete bibliography}



\subsection{Unconstrained EPQ-BS}
\label{sec:lot-size:single-line:models:unconstrained}


%Using the average value of the inventory of each product over time, the optimization problem can be written as follow:
We address the following alternative mathematical problem.
%We claim that the following optimization problem is a correct model of the unconstrained EPQ-BS in its unconstrained version:
\begin{subequations}\label{eq:lot-size:single-line:deterministic:unconstrained}
  \begin{align+}
  \min\quad & \ds\sum_{i\in\REF} \frac{1}{2}\holding_i\tilde{\demand}_i\cover_i
  \label{eq:lot-size:single-line:deterministic:unconstrained:objective}
  \\
  \st\quad  & \ds\sum_{i\in\REF} \frac{1}{\cover_i} \le \nbsetups
  \label{eq:lot-size:single-line:deterministic:unconstrained:flexibility}
  \\
       & \cover_i > 0 && \forall i\in\REF,
  \label{eq:lot-size:single-line:deterministic:unconstrained:positivity}
  \end{align+}
\end{subequations}
where $\tilde{\demand}_i=\bracket{1-\frac{\demand_i}{\rate_i}}\demand_i$.
% is the reduced value of the demand.

\begin{thm}\label{thm:lot-size:single-line:deterministic:unconstrained:optimality}
Problem~\eqref{eq:lot-size:single-line:deterministic:unconstrained} has a unique optimal solution $(\cover_i^*)_{i\in\REF}$ with
\begin{equation}
  \cover_i^*= \frac{\sum_{j\in\REF}\sqrt{\holding_j\tilde{\demand}_j}}{\nbsetups\sqrt{\holding_i\tilde{\demand}_i}}\qquad\forall i\in\REF
\end{equation}
and optimal cost equal to $\frac{1}{2\nbsetups}\bracket{\sum_{i\in\REF}\sqrt{\holding_i\tilde{\demand_i}}}^2$.

Moreover, the optimal solution of Problem~\eqref{eq:lot-size:single-line:deterministic:unconstrained} is the optimal solution of unconstrained EPQ-BS.
\end{thm}


Formulation \eqref{eq:lot-size:single-line:deterministic:unconstrained} have many advantages.
First, it is much simpler than the original formulation of \cref{sec:lot-size:single-line:deterministic:problems}.
Second, it removes from the formulation the first setups of production $\bracket{t_i}_i$ which are not a desired output.


The link between both problem is however not necessarily immediate.
As we will see, formulation \eqref{eq:lot-size:single-line:deterministic:unconstrained} assumes that optimal policy is \emph{Zero-Inventory-Ordering (ZIO)}.
We recall that a policy is said to be ZIO if an order can only occurs when the inventory is zero.
Due to flexibility constraint \eqref{eq:lot-size:single-line:deterministic:motivations:flexibility}, production should have to be anticipated before inventory reach zero.


% For each item $i$, let $\freq_i\bracket{t}$ be the number of setups during the interval $[0,t)$ and $\freq_i$ the average number of setups per time unit over the infinite horizon.
% Let $t_i$ be the first production setup of item $i$.
% Then, according to problem description in \cref{sec:lot-size:single-line:deterministic:problems}, production setups occur at times $t_i+k\,\cover_i$ with $k\in\ZZ_+$.


\begin{lem}\label{lem:lot-size:single-line:deterministic:unconstrained:optimality}
Problem~\eqref{eq:lot-size:single-line:deterministic:unconstrained} has a unique optimal solution $(\cover_i^*)_{i\in\REF}$.
\end{lem}


\begin{proof}
Since Problem~\eqref{eq:lot-size:single-line:deterministic:unconstrained} is a convex problem, solving it is straightforward using the Karush-Kuhn-Tucker conditions which gives the unique solution
\begin{equation}
  \cover_i^*= \frac{\sum_{j\in\REF}\sqrt{\holding_j\tilde{\demand}_j}}{\nbsetups\sqrt{\holding_i\tilde{\demand}_i}}\qquad\forall i\in\REF,
\end{equation}
with optimal cost $\frac{1}{2\nbsetups}\bracket{\sum_{i\in\REF}\sqrt{\holding_i\tilde{\demand_i}}}^2$.
\end{proof}



\begin{lem}\label{lem:lot-size:single-line:models:average-setup}
%For each item $i$, average number $\freq_i$ of setups per time unit over the infinite horizon is equal to $\frac{1}{\cover_i}$ where $\cover_i$ is the cover and flexibility constraint described in \cref{sec:lot-size:single-line:deterministic:problems} can be written as
Flexibility constraint \eqref{eq:lot-size:single-line:deterministic:motivations:flexibility} is equivalent to
$\ds\sum_{i\in\REF} \frac{1}{\cover_i} \le \nbsetups$.
\end{lem}


\begin{proof}
For a time $\horizon>t_i$, the average number of setups per time unit during the interval $[0,\horizon)$ is
$\frac{1}{\horizon}\left\lfloor\frac{\horizon-t_i}{\cover_i}\right\rfloor$
which converges to $\frac{1}{\cover_i}$ when $\horizon$ goes to infinity.
Equivalence immediately follows.
\end{proof}


Note that this formulation is independent of the first production setup $t_i$.
Then, choice of $t_i$ is only constrained by positive inventory.


\begin{lem}\label{lem:lot-size:single-line:models:ZIO}
Let $\bracket{t_i^*,\cover_i^*}_{i\in\REF}$ be an optimal solution of unconstrained EPQ-BS.
Then, this solution is Zero-Inventory-Ordering, and its cost is given by
\begin{equation}
  \sum_{i\in\REF}\frac{1}{2}\holding_i\bracket{1-\frac{\demand_i}{\rate_i}}\demand_i\cover_i^*
\end{equation}
and we have $t_i^*=\frac{\inventory_i(0)}{\demand_i}$ for each item $i$.
\end{lem}


\begin{proof}
Let $\bracket{t_i^*,\cover_i^*}_{i\in\REF}$ be an optimal solution of unconstrained EPQ-BS.
Using the dynamic \eqref{eq:lot-size:single-line:deterministic:motivations:dynamic}, we have for each item $i$
\begin{equation}
  S_{i,0}
  =
  \int_0^{t_i^*}\inventory_i\bracket{t}dt
  = \frac{1}{2}\bracket{2\inventory_i\bracket{0}-t_i^*\demand_i}t_i^*,
\end{equation}
and for each $k\in\ZZ_+$
\begin{equation}
  S_{i,k}
  =
  \int_{t_i^*+k\cover_i^*}^{t_i^*+\bracket{k+1}\cover_i^*}\inventory_i(t)dt
  =
  \bracket{\inventory_i(0)-\demand_i t_i^*}\cover_i^*
  + \frac{1}{2}\bracket{1-\frac{\demand_i}{\rate_i}}\demand_i\cover_i^{*2}.
\end{equation}
Let $\horizon$ be a real number greater than $t_i^*$.
Splitting the integral, we get
\begin{equation}
  \frac{1}{\horizon} S_{i,0}
  + \frac{1}{\horizon} \sum_{k=1}^{\left\lfloor\frac{\horizon-t_i^*}{\cover_i^*}\right\rfloor-1} S_{i,k}
  \le
  \frac{1}{\horizon} \int_0^{\horizon}\inventory_i\bracket{t}dt
  \le
  \frac{1}{\horizon} S_{i,0}
  + \frac{1}{\horizon} \sum_{k=1}^{\left\lfloor\frac{\horizon-t_i^*}{\cover_i^*}\right\rfloor} S_{i,k}
\end{equation}
and the average cycle stock on infinite horizon for item $i$ follows:
\begin{equation}
  \lim_{\horizon\rightarrow\infty} \frac{1}{\horizon} \int_0^{\horizon}\inventory_i\bracket{t}dt
  =
  \inventory_i(0)-\demand_i t_i^*
  + \frac{1}{2}\bracket{1-\frac{\demand_i}{\rate_i}}\demand_i\cover_i^*.
\end{equation}
Thanks to \cref{lem:lot-size:single-line:models:average-setup}, $\bracket{t_i^*,\cover_i^*}_{i\in\REF}$ is feasible for every $t_i^*\le\frac{\inventory_i(0)}{\demand_i}$ but optimality implies that $t_i^*=\frac{\inventory_i(0)}{\demand_i}$.
Then, an optimal solution of unconstrained EPQ-BS is Zero-Inventory-Ordering and its cost is
\begin{equation}
  \sum_{i\in\REF}\frac{1}{2}\holding_i\bracket{1-\frac{\demand_i}{\rate_i}}\demand_i\cover_i^*.
\end{equation}
\end{proof}


%Thanks to \cref{prop:lot-size:single-line:models:average-setup} and \cref{prop:lot-size:single-line:models:ZIO}, problem \eqref{eq:lot-size:single-line:deterministic:unconstrained} is a correctly models the unconstrained version of the problem described \cref{sec:lot-size:single-line:deterministic:problems}.



\begin{proof}[Proof of \cref{thm:lot-size:single-line:deterministic:unconstrained:optimality}]
\cref{lem:lot-size:single-line:models:average-setup} and \cref{lem:lot-size:single-line:models:ZIO} prove that every optimal solutions of unconstrained EPQ-BS is a solution of Problem \ref{eq:lot-size:single-line:deterministic:unconstrained} with the same cost.
Conversely, an optimal solution of Problem \ref{eq:lot-size:single-line:deterministic:unconstrained} can be completed in a solution of unconstrained EPQ-BS with the same cost setting the first production setup $t_i$ of item $i$ equal to $\frac{\inventory_i(0)}{\demand_i}$.
Then, the unique optimal solutions of Problem \ref{eq:lot-size:single-line:deterministic:unconstrained} (\cref{lem:lot-size:single-line:deterministic:unconstrained:optimality}) is the optimal solution of unconstrained EPQ-BS.
\end{proof}


\medskip


Note that model simply adapts to case where production is considered instantaneous (\ie $\rate_i\rightarrow\infty$).
In this case, just use real demand $\demand_i$ instead of modified demand $\bar{\demand}_i=\bracket{1-\frac{\demand_i}{\rate_i}}\demand_i$.


% Then, if such a limit exists, we must have
% \begin{equation}
%   \limsup_{t\rightarrow\infty}\frac{1}{t} \sum_{i\in\REF}\freq_i\bracket{t}\le\nbsetups.
% \end{equation}


% \begin{proof}
% Scheme of proof:
% \begin{itemize}
%   \item expression of the constraint
%   \item ZIO policy
%   \item expression of the objective
% \end{itemize}
% \end{proof}




% Using the production frequencies $\freq_i=\frac{1}{\cover_i}$ of product $r$, we get the optimal frequencies:
% \begin{equation}
%   \freq_i^* = \frac{1}{\cover_i^*}
%             = \frac{\nbsetups\sqrt{\holding_i\demand_i}}{\sum_{s\in\REF}\sqrt{\holding_s\demand_s}}
%             \quad \forall i\in\REF,
% \end{equation}
% and the associated holding cost is $\frac{1}{2\nbsetups}\bracket{\sum_{i\in\REF}\sqrt{\holding_i\demand_i}}^2$.


% \esgil{Write the proof}



\subsection{Integer EPQ-BS}


%In some cases, it is easier for industrial to use integer frequencies.
% As explained in \cref{sec:lot-size:single-line:models:unconstrained}, dealing with finite or infinite internal production time $\rate_i$ is very similar since, it is sufficient to use the demand $\demand_i$ or the modified demand $\tilde{\demand}_i$ in problem \eqref{eq:lot-size:single-line:deterministic:unconstrained}.
% Thus, we only write the case with infinite internal production time $\rate_i$.
In some cases, it is easier for companies to use integer frequencies.
We address the following alternative mathematical problem.
\begin{subequations}\label{eq:lot-size:single-line:deterministic:integer}
  \begin{align+}
  \min\quad & \ds\sum_{i\in\REF} \frac{1}{2}\holding_i\tilde{\demand_i}\frac{1}{\freq_i}
  \label{eq:lot-size:single-line:deterministic:integer:objective}
  \\
  \st\quad  & \ds\sum_{i\in\REF} \freq_i \le \nbsetups
  \label{eq:lot-size:single-line:deterministic:integer:flexibility}
  \\
       & \freq_i \in \ZZ_+^* && \forall i\in\REF,
  \label{eq:lot-size:single-line:deterministic:integer:positivity}
  \end{align+}
\end{subequations}
where $\freq_i=\frac{1}{\cover_i}$ is the average number of setups per time unit over the infinite horizon and $\bar{\demand}_i=\bracket{1-\frac{\demand_i}{\rate_i}}\demand_i$.


Proving that optimal solutions of Problem \eqref{eq:lot-size:single-line:deterministic:integer} are the optimal solution of integer EOQ-BS is very similar to the unconstrained case since proofs of \cref{lem:lot-size:single-line:models:average-setup} and of \cref{lem:lot-size:single-line:models:ZIO} does not relies on the continuities of the covers $\bracket{\cover_i}_i$.
Moreover, as explained in \cref{sec:lot-size:single-line:models:unconstrained}, dealing with finite or infinite internal production time $\rate_i$ is very similar since, it is sufficient to use the demand $\demand_i$ in infinite case instead of the modified demand $\tilde{\demand}_i$ in problem \eqref{eq:lot-size:single-line:deterministic:integer}.


\medskip


This formulation is a special case of the integer simple resource allocation problem:
\begin{equation}
  \max\crbracket{\sum_{i\in\REF} f_i\bracket{\freq_i}\ \left|\ \sum_{i\in\REF}\freq_i=\nbsetups,\quad\freq\in \ZZ_+^*\right.}
\end{equation}
where the $f_i$ are concave.


The fastest algorithm known has a $O\bracket{\card{\REF}\log{\frac{\nbsetups}{\card{\REF}}}}$ running time and was proposed by \cite{Frederickson1982} and then simplified by \cite{Hochbaum1994}.
Implementation of these algorithms is not easy.
Dynamic programming might be used instead, but its complexity is only $O\bracket{\card{\REF}\nbsetups^2}$ which is pseudo-polynomial.



\section{Stochastic settings}


\subsection{Problem}
\label{sec:lot-size:single-line:stochastic:problem}


As in \cref{sec:lot-size:single-line:deterministic:problems}, cycle stocks are managed using $(r,\cover)$ policies (\ie cover policies).
However, in real life, many parameters are not known in advance.
An obvious example is demand which can changes due to forecast errors, marketing promotions, passing fads.
Randomness can also comes from production means.
Failures, holidays or strikes can affect internal production time.


Production means are assumed to be reliable and we only consider randomness on demand.
The problem becomes an assembly line still producing a set $\REF$ of items over an infinite horizon.
The internal production time of item $i$ is $\rate_i$.
Inventory $\va\inventory_i$ of item $i$ must satisfy a random demand.
Then it continuously decreases by $\va\demand_i<\rate_i$ units per time unit when there is no production and continuously increases by $\rate_i-\va\demand_i$ units per time unit when item $i$ is produced.
%Note that inventory $\va\inventory_i$ and demand $\va\demand_i$ are in bold to indicate that they are random.
Moreover, $\va\demand_i$ is assumed to be almost surely lower than $\rate_i$.


Orders of production of item $i$ can be placed at any time, even simultaneously but the cover $\cover_i$ of a given item $i$ has to be the same over the infinite horizon.
Covers are decided before the demand is revealed.
When demand is revealed once and for all, the duration $\theta_i$ of the order of production is fixed at value $\frac{\demand_i}{\rate_i}\cover_i$.
Covers $\bracket{\cover_i}_i$ are called \emph{first-stage decision} since they are decided before hazard realization whereas first setups $\bracket{\va t_i}_i$ and durations $\bracket{\va\theta_i}_i$ are called second-stage decisions (or recourse).

Thus, for each item $i$, inventory $\va\inventory_i\bracket{t}$ is nonnegative and follows almost surely the dynamic
\begin{equation}\label{eq:lot-size:single-line:stochastic:motivations:dynamic}
  \dot{\va\inventory}_i\bracket{t} =
  \left\{
  \begin{array}{ll}
  \rate_i-\va\demand_i
  & \ds\mbox{if}\ t\in\bigcup_{k\in\ZZ_+} \left[\va t_i+k\cover_i,\va t_i+\bracket{k+\frac{\va\demand_i}{\rate_i}}\cover_i\right),
  \\
  -\va\demand_i
  & \mbox{otherwise}.
  \end{array}
  \right.
\end{equation}

%(It imposes that the solution is periodic for each item.)
Flexibility is still modeled by a constraint.
In average over the infinite horizon, the number of setups per unit time for all items must be lower than $\nbsetups$ which can be written as
\begin{equation}\label{eq:lot-size:single-line:stochastic:motivations:flexibility}
  \limsup_{\horizon\rightarrow+\infty}\ \frac{1}{\horizon} \sum_{i\in\REF} \left\lfloor\frac{\horizon-\va t_i}{\cover_i}\right\rfloor \le \nbsetups \quad \mbox{almost surely}.
\end{equation}

For each item $i$, there is an initial inventory $s_i\bracket{0}\in\RR_+$.


Storing one unit of item $i$ incurs a unit holding cost $\holding_i>0$ per unit time.
Objective is to find the covers which minimize the average cycle stock over infinite horizon
\begin{equation}
  \limsup_{\horizon\rightarrow+\infty}
  \ 
  \espe\sqbracket{
  \frac{1}{\horizon} \sum_{i\in\REF} \holding_i \int_0^{\horizon}\va\inventory_i\bracket{t}dt
  }
\end{equation}
while satisfying almost surely positive inventory, constraint~\eqref{eq:lot-size:single-line:stochastic:motivations:dynamic} and constraint~\eqref{eq:lot-size:single-line:stochastic:motivations:flexibility}.


We call this problem \emph{stochastic Economic Production Quantity model with Bounded number of Setups (stochastic EPQ-BS)} and will consider the same two versions as in deterministic case:
\begin{itemize}
  \item the covers can be any nonnegative real numbers (called \emph{unconstrained}),
  \item the covers have to be inverses of integers (called \emph{integer}).
\end{itemize}



\subsection{Bibliography}

Source of randomness:
\begin{itemize}
  \item customer demand
  \item manufacturing time (internal production time)
  \item delivery lead time
\end{itemize}

Randomness was handled by probability (most cases) but also with fuzzy set theory (\eg \cite{Park1987,Lee1999,Wang2007} for extensions of the EOQ and \cite{Ziukov2015} for a complete review of the extensions of EOP, EPQ, Joint Economic Lot Sizing models).
In what follows, we focus on randomness represented by probability.

Literature often include backorder costs!

\medskip

\textbf{Ordering}

One period:
\begin{itemize}
  \item News-vendor problem \cite{Edgeworth88,Arrow1951}
\end{itemize}

Continuous-review:
\begin{itemize}
  \item adaptation of (r,q) policies with EOQ taking into account random demand during lead-time \cite{Gallego1998}
\end{itemize}

\medskip

\textbf{Production}




\esgil{Complete bibliography}



\subsection{Unconstrained stochastic EPQ-BS}


%We claim that the following optimization problem is a correct model of the problem described in \cref{sec:lot-size:single-line:stochastic:motivations}.
We address the following alternative mathematical problem.
\begin{subequations}\label{eq:lot-size:single-line:stochastic:unconstrained}
  \begin{align}
  \min\quad & \ds\sum_{i\in\REF} \frac{1}{2}\holding_i\tilde{\tilde{\demand}}_i\cover_i
  \label{eq:lot-size:single-line:stochastic:unconstrained:objective}
  \\
  \st\quad  & \ds\sum_{i\in\REF} \frac{1}{\cover_i} \le \nbsetups
  \label{eq:lot-size:single-line:stochastic:unconstrained:flexibility}
  \\
       & \cover_i > 0 && \forall i\in\REF,
  \label{eq:lot-size:single-line:stochastic:unconstrained:positivity}
  \end{align}
\end{subequations}
where $\tilde{\tilde{\demand}}_i=\bracket{1-\frac{\espe\sqbracket{\va\demand_i}}{\rate_i}}\espe\sqbracket{\va\demand_i} - \frac{\vari\sqbracket{\va\demand_i}}{\rate_i}$.
%is the reduced value of the demand in stochastic case.

\begin{thm}\label{thm:lot-size:single-line:stochastic:unconstrained:optimality}
Problem~\eqref{eq:lot-size:single-line:stochastic:unconstrained} has a unique optimal solution $(\cover_i^*)_{i\in\REF}$ with
\begin{equation}
  \cover_i^*= \frac{\sum_{j\in\REF}\sqrt{\holding_j\tilde{\tilde{\demand}}_j}}{\nbsetups\sqrt{\holding_i\tilde{\tilde{\demand}}_i}}\qquad\forall i\in\REF
\end{equation}
and optimal cost equal to $\frac{1}{2\nbsetups}\bracket{\sum_{i\in\REF}\sqrt{\holding_i\tilde{\tilde{\demand}}_i}}^2$.

Moreover, the optimal solution of Problem~\eqref{eq:lot-size:single-line:stochastic:unconstrained} is the optimal solution of unconstrained stochastic EPQ-BS.
\end{thm}


Suppose that program~\eqref{eq:lot-size:single-line:stochastic:unconstrained} is a correct formulation of the unconstrained stochastic EPQ-BS. Then, adaptation of results from deterministic cases to stochastic cases is straightforward.
Moreover, when the only randomness comes from the demand, we also show that the optimal solution is completely determined by the expectation and the variance of each of the demand $\va\demand_i$.
Note that the optimal solution is not obtained by replacing the demand by its expectation.



\begin{lem}\label{lem:lot-size:stochastic:single-line:models:average-setup}
Flexibility constraint \eqref{eq:lot-size:single-line:stochastic:motivations:flexibility} is equivalent to
$\ds\sum_{i\in\REF} \frac{1}{\cover_i} \le \nbsetups$.
\end{lem}


\begin{proof}
For a time $\horizon>\va t_i$, the average number of setups per time unit during the interval $[0,\horizon)$ is
$\frac{1}{\horizon}\left\lfloor\frac{\horizon-t_i}{\cover_i}\right\rfloor$
which converges to $\frac{1}{\cover_i}$ when $\horizon$ goes to infinity.
Equivalence immediately follows.
\esgil{Problem at this point. $\horizon$ may not exist. Directly write with expectation? How? (See AZ)}
\end{proof}



\begin{lem}\label{lem:lot-size:stochastic:single-line:models:ZIO}
Let $\bracket{\va t_i^*,\cover_i^*}_{i\in\REF}$ be an optimal solution of unconstrained stochastic EPQ-BS.
Then, this solution is Zero-Inventory-Ordering, and its cost is given by
\begin{equation}
  \sum_{i\in\REF}\frac{1}{2}\holding_i\sqbracket{\bracket{1-\frac{\espe\sqbracket{\va\demand_i}}{\rate_i}}\espe\sqbracket{\va\demand_i} - \frac{\vari\sqbracket{\va\demand_i}}{\rate_i}}\cover_i^*
\end{equation}
and we have almost surely $\va t_i^*=\frac{\inventory_i(0)}{\va\demand_i}$ for each item $i$.
\end{lem}


\begin{proof}
Let $\bracket{\va t_i^*,\cover_i^*}_{i\in\REF}$ be an optimal solution of unconstrained EPQ-BS.
Using the dynamic \eqref{eq:lot-size:single-line:stochastic:motivations:dynamic}, we have for each item $i$
\begin{equation}
  \espe\sqbracket{\va S_{i,0}}
  = \espe\sqbracket{\int_0^{\va t_i^*}\va\inventory_i\bracket{t}dt}
  = \espe\sqbracket{\frac{1}{2}\bracket{2\inventory_i\bracket{0}-\va t_i^*\va\demand_i}\va t_i^*}
  = \frac{1}{2}\bracket{2\inventory_i\bracket{0}\espe\sqbracket{\va t_i^*}-\espe\sqbracket{\va t_i^*^2\va\demand_i}}
\end{equation}
and for each $k\in\ZZ_+$
\begin{subequations}
\begin{align}
  \espe\sqbracket{\va S_{i,k}}
  &= \espe\sqbracket{\int_{\va t_i^*+k\cover_i^*}^{\va t_i^*+\bracket{k+1}\cover_i^*}\va\inventory_i(t)dt}
  = \espe\sqbracket{\bracket{\inventory_i(0)-\va\demand_i \va t_i^*}\cover_i^*
  + \frac{1}{2}\bracket{1-\frac{\va\demand_i}{\rate_i}}\va\demand_i\cover_i^{*2}}
  \\
  &= \bracket{\inventory_i(0)-\espe\sqbracket{\va\demand_i \va t_i^*}}\cover_i^*
  + \frac{1}{2}\bracket{\espe\sqbracket{\va\demand_i}-\frac{\espe\sqbracket{\va\demand_i^2}}{\rate_i}}\cover_i^{*2}.
  \end{align}
\end{subequations}
Let $\horizon$ be a real number almost surely greater than $\va t_i^*$.
\esgil{Problem at this point. $\horizon$ may not exist. Directly write with expectation? How? (See AZ)}
Splitting the integral, we get
\begin{equation}
  \frac{1}{\horizon} \va S_{i,0}
  + \frac{1}{\horizon} \sum_{k=1}^{\left\lfloor\frac{\horizon-\va t_i^*}{\cover_i^*}\right\rfloor-1} \va S_{i,k}
  \le
  \frac{1}{\horizon} \int_0^{\horizon}\va\inventory_i\bracket{t}dt
  \le
  \frac{1}{\horizon} \va S_{i,0}
  + \frac{1}{\horizon} \sum_{k=1}^{\left\lfloor\frac{\horizon-\va t_i^*}{\cover_i^*}\right\rfloor} \va S_{i,k}
  \quad \mbox{almost surely}.
\end{equation}
and the average cycle stock on infinite horizon for item $i$ follows:
\begin{equation}
  \lim_{\horizon\rightarrow\infty} \frac{1}{\horizon} \int_0^{\horizon}\va\inventory_i\bracket{t}dt
  =
  \inventory_i(0)-\va\demand_i \va t_i^*
  + \frac{1}{2}\bracket{1-\frac{\va\demand_i}{\rate_i}}\va\demand_i\cover_i^*
  \quad \mbox{almost surely}.
\end{equation}
Thanks to \cref{lem:lot-size:single-line:models:average-setup}, $\bracket{\va t_i^*,\cover_i^*}_{i\in\REF}$ is feasible for every $\va t_i^*\le\frac{\inventory_i(0)}{\va\demand_i}$ but optimality implies that $\va t_i^*=\frac{\inventory_i(0)}{\va\demand_i}$.
Then, an optimal solution of unconstrained EPQ-BS is Zero-Inventory-Ordering and its cost is
\begin{equation}
  \sum_{i\in\REF}\frac{1}{2}\holding_i\bracket{1-\frac{\va\demand_i}{\rate_i}}\va\demand_i\cover_i^*.
\end{equation}
\end{proof}



\begin{proof}[Proof of \cref{thm:lot-size:single-line:stochastic:unconstrained:optimality}]
\cref{lem:lot-size:stochastic:single-line:models:average-setup} and \cref{lem:lot-size:stochastic:single-line:models:ZIO} show that program~\eqref{eq:lot-size:single-line:stochastic:unconstrained} is a correct formulation of the stochastic EPQ-BS.
The other results are straightforward with Karush-Kuhn-Tucker conditions.
\end{proof}



\subsection{Integer stochastic EPQ-BS}



When dealing with integer frequencies, we use the following formulation.
\begin{subequations}\label{eq:lot-size:single-line:stochastic:integer}
  \begin{align+}
  \min\quad & \ds\sum_{i\in\REF} \frac{1}{2}\holding_i\tilde{\tilde{\demand_i}}\frac{1}{\freq_i}
  \label{eq:lot-size:single-line:stochastic:integer:objective}
  \\
  \st\quad  & \ds\sum_{i\in\REF} \freq_i \le \nbsetups
  \label{eq:lot-size:single-line:stochastic:integer:flexibility}
  \\
       & \freq_i \in \ZZ_+^* && \forall i\in\REF,
  \label{eq:lot-size:single-line:stochastic:integer:positivity}
  \end{align+}
\end{subequations}
where $\freq_i=\frac{1}{\cover_i}$ is the average number of setups per time unit over the infinite horizon and $\tilde{\tilde{\demand}}_i=\bracket{1-\frac{\espe\sqbracket{\va\demand_i}}{\rate_i}}\espe\sqbracket{\va\demand_i} - \frac{\vari\sqbracket{\va\demand_i}}{\rate_i}$.


Proving that optimal solutions of Problem \eqref{eq:lot-size:single-line:stochastic:integer} are the optimal solution of stochastic integer EOQ-BS is very similar to the unconstrained case since proofs of \cref{lem:lot-size:stochastic:single-line:models:average-setup} and of \cref{lem:lot-size:stochastic:single-line:models:ZIO} does not relies on the continuities of the covers $\bracket{\cover_i}_i$.
Moreover, like in deterministic case, dealing with finite or infinite internal production time $\rate_i$ is very similar since, it is sufficient to use demand's expectation $\espe\sqbracket{\va\demand_i}$ instead of the modified demand $\tilde{\tilde{\demand}}_i$ in problem \eqref{eq:lot-size:single-line:stochastic:integer}.


Finally, adaptation of results proved in deterministic case is straightforward since program~\eqref{eq:lot-size:single-line:stochastic:integer} is a correct formulation of the stochastic integer EPQ-BS.

