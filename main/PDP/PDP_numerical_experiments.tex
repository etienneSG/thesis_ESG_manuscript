%!TEX root=../../thesis_ESG.tex
\chapter{Numerical experiments}
\label{chap:PDP:numerical-experiments}

% This thesis was motivated by an industrial problem.
% The objective being both theoretical and applied, after retrieving data from Argon Consulting's clients, we test our method on real world instances and empirically show that the method we propose lead to great improvement in inventory management.

% \esgil{Rendre le paragraphe plus spécifique au model tactique.}


To test the efficiency of our approach, we retrieve datasets from Argon Consulting's clients.
Then, we simulate the sequence of production periods and emulate the behavior of people making production planning decisions to compare their consequences to the ones of decisions taken by our approach.
We empirically show that the method we propose lead to improvement in inventory management.


\section{Simulation}


In this chapter, each method used to compute a production planning is called an \emph{heuristic} since it cannot guarantee to reach the optimum.
Moreover, we are not able to prove than one heuristic is theoretically better than another.
Thus, in order to compare their efficiency, we use simulations.


The simulation emulates the behavior of people making production planning facing uncertainty.
First, we define assembly line data and a forecast demand which is a function of the current period and of the past outcomes.
Then, we choose a heuristic to compute the production planning.


We use a repeated approach starting at period $t=1$.
For each period $t$, we observe the current inventory level of each item, \ie the inventory at the end of the previous period.
Using the forecast demand function and the chosen heuristic, we compute the production planing and fix the decision for the current period $t$.
In real life, it correspond to starting the production for the current period without deviating from the planning.
At the end of the period, we observe the demand outcome for period $t$ and update the inventory level.


At the end of the simulation, we get several \emph{Key Performance Indicators (KPI)} measuring the efficiency of the heuristic.


A scheme of a typical run of the simulation is given in \cref{fig:simulator}.

\begin{figure}[h]
  \centering
  \includegraphics{main/PDP/images/simulator.tikz}
  \caption{Scheme of the run of the simulation}
  \label{fig:simulator}
\end{figure}


C++11 has been chosen for the implementations and Gurobi 6.5.1~\cite{gurobi} was used to solve the model on a PC with 8 processor Intel\textregistered\ Xeon\texttrademark\ E5-2667 @ 3.30GHz and 48Go RAM.




\section{Heuristics}


Our heuristic consists in solving (2SA-$m$) as defined in \vl{Problem~\eqref{eq:Uniform-CLSP-BS-2SA-m:backorder}} at the beginning of each period $t$.
We compare it with three other heuristics:
\begin{itemize}
  \item deterministic approximation,
  \item lot-size,
  \item cover-size.
\end{itemize}


The first heuristic is the deterministic version of Problem~\eqref{eq:Uniform-CLSP-BS:backorder}, where the random demand is replaced by its expectation.
Note that it is not the CLSP-BS described in \cref{chap:PDP:deterministic} since there are backorder costs.
When backorder cost are not given by the client, we used the method described in \cref{sec:PDP:stochastic:model:backorder} to compute them.


The second one, the {\em lot-size heuristic}, consists in determining before the first week once and for all a value $\ell_i^*$ for each item $i\in\REF$.
At time $t$, if the inventory of item $i$ is below a precomputed safety stock (see \cref{eq:PDP:numerical-experiments:safety-stock}), the quantity $\quantity_t^i$ is chosen so that the inventory of item $i$ exceeds the safety stock of exactly $\ell_i^*$.
Indeed, as shown in \cref{fig:lot-size-production}, the inventory level at the end of a period may be lower than the safety stock.
In case of capacity issues, the production is postponed and thus backorder costs appear.
In addition, if some capacity issues are easily anticipated, the production of an item $i$ can be activated even if the inventory is not below the safety stock.

\begin{figure}[h]
  \centering
  \esgil{Add figure to represent the production for the lot-size heuristic.}
%  \includegraphics{main/PDP/images/simulator.tikz}
  \caption{Computation of quantity to produce using lot-size heuristic}
  \label{fig:lot-size-production}
\end{figure}

\esgil{Préciser que ça vient d'une modélisation gaussienne de la demande et que c'est classiquement admis dans la littérature.}

The third one, the {\em cover-size heuristic}, is almost the same, but instead of precomputing a fixed quantity for each item, a duration $\tau_i^*$ is fixed before the first week.
When the inventory of item $i$ is below the safety stock, the quantity $\quantity_t^i$ is computed so that the inventory of item $i$ exceeds the safety stock of the expected demand for the next $\tau_i^*$ weeks.
An example is given on \cref{fig:cover-size-production}.

\begin{figure}[h]
  \centering
  \esgil{Add figure to represent the production for the cover-size heuristic.}
  \esgil{Fuse with \cref{fig:lot-size-production} or two sub-figures.}
%  \includegraphics{main/PDP/images/simulator.tikz}
  \caption{Computation of quantity to produce using cover-size heuristic}
  \label{fig:cover-size-production}
\end{figure}


The values $\ell_i^*$ and $\tau_i^*$ are determined using results of \cref{chap:lot-size:single-line}.
$(\tau_i^*)_{i\in\REF}$ is actually chosen to be the optimal solution to Program~\eqref{eq:cont-rev-det}, which somehow considers the problem at a ``macroscopic'' level
%(Similar convex programs in the same context have been considered in the literature; see~\cite{Ziegler1982} for example.)
where the demand $\demand^i$ is chosen equal to $\espe\sqbracket{\sum_{t=1}^{\horizon}\va d_t^i}$.

For each item $i$, the parameter $\ell_i^*$ of the lot-size heuristic is then set to $\demand^i\tau_i^*$.


There is no universal formula for safety stocks $\bracket{\safety^i}_i$.
Thus we turn to the formula used in practice by most of Argon Consulting's clients (see \cite[Chapter 11]{arnold2007})\vlil{where the underlying}
model assumes that demand has a Gaussian distribution.
Production being decided at the beginning of the period and the demand being revealed at the end of the period, the lead time is one period (and is certain).
Thus, for each item $i$, the safety stock used to reach cycle service level $\alpha$ is
\begin{equation}\label{eq:PDP:numerical-experiments:safety-stock}
  \safety^i = z_{\alpha} \sqrt{\vari\sqbracket{\va\demand^i}}
\end{equation}
where $\va\demand^i=\sum_{t=1}^{\horizon}\va\demand_t^i$ and $z_{\alpha}$ is the inverse distribution function of a standard normal distribution with cumulative probability $\alpha$.
When fill rate service level $\servicelvl$ is used, an abacus gives the coefficient $k_{\servicelvl}$ which must be used instead of $z_{\alpha}$.


\medskip

The cover-size heuristic adapts the production to the realization of the demand, contrary to the lot-size heuristic.
According to Argon Consulting, it makes the cover-size heuristic more suitable for situations with low short term volatility of demand or for overcapacitated lines, while the lot-size heuristic is expected to behave better with high short term volatility of demand or for undercapacitated lines.


Note that the backorder costs are not taken into account at all for determining the values of the parameters $\ell_i^*$ and $\tau_i^*$.
But playing with safety stocks allows to prevent too large backorder costs.
However, in real life it is usually the other way round: the company does not associate costs to backorder and aims at keeping the total amount of unsatisfied demand below some predetermined level.




\section{Instances and probabilistic model}
\label{sec:PDP:numerical-experiments:instances}


\subsection{Datasets}
\label{sec:PDP:numerical-experiments:historical-data}

The instances used are realistic and have been provided by a client of Argon Consulting.
The client gave the data of seven assembly lines and the demand for each week over an full quarter.
The horizon $\horizon$ is the typical one used in practice by this client, namely $\horizon=13$ weeks.

The historical demand are denoted by $\bar{\demand}_t^i$.

The initial inventory is set to $s_0^i=\frac{1}{3}(\bar{\demand}_1^i+\bar{\demand}_2^i+\bar{\demand}_3^i)$.

The other parameters are provided in \cref{tab:instances-characteristics}.
%In particular, for each value of $v$, we have considered three possible values of the unit backorder cost $\backorder$, which have been determined following a procedure described in Section~\cref{sec:service}. At the moment, we do not discuss further these values and take them as part of the input, as required by the problem formulation.
The parameter $C$ is the capacity of the line before normalization.
(Recall that the problem and the model have been formulated in \cref{sec:PDP:stochastic:model} after normalization.)
In the column $\tilde{\holding}^i$, we indicate the range of the holding costs before normalization.
We obtain the $\holding^i$'s by dividing these costs by $C$ since internal production times $\rate^i$ are unitary.

We also add the loading indicator $\kappa_t$ at period $t$ defined as:
\begin{equation}
  \kappa_t = \frac{\sum_{i\in\REF} \bracket{\sum_{t'=1}^{t} \bar{\demand}_{t'}^i}-\inventory_0^i}{ \sum_{t'=1}^{t} \capacity_{t'}}
\end{equation}
It is the ratio of cumulative forecast demand up to period $t$ minus the initial inventory over cumulative capacity up to period $t$.
If there were no flexibility constraints and if the holding costs were not an issue, then for a period $t$, $\kappa_t \le 100\%$ implies that it is possible to supply the whole demand.
As shown in \cref{tab:instances-characteristics}, the lines $L_0$, $L_1$, $L_2$, $L_3$ and $L_4$ experience overcapacity: the loading indicator is smaller than $100\%$.
The lines $L_5$ and $L_6$ experience undercapacity: the loading indicator is larger than $100\%$ at some periods.

\begin{table}[ht]
\begin{center}
\begin{tabular*}{\linewidth}{@{\extracolsep{\fill}}lrrrrrrr@{\extracolsep{\fill}}}
\hline
Instances &
\multicolumn{7}{c}{Instance characteristics}
\\\cline{2-8}
\\
& $\card{\REF}$
& $\max(\bar{\demand}_t^i)$
& \multicolumn{1}{c}{$\capacity$}
& \multicolumn{1}{c}{$\nbsetups$}
& \multicolumn{1}{c}{$\tilde{\holding}^i$}
& \multicolumn{1}{c}{$\max\bracket{\kappa_t}$}
& \multicolumn{1}{c}{$\kappa_{\horizon}$}
\\\hline
$L_0$ & $21$ & $3780$ & $8518$ & $7$ & $45$--$88$ & $91\%$ & $74\%$
\\
$L_1$ & $30$ & $4122$ & $13326$ & $12$ & $52$--$82$ & $66\%$ & $52\%$
\\
$L_2$ & $21$ & $4992$ & $10562$ & $7$ & $35$--$61$ & $61\%$ & $61\%$
\\
$L_3$ & $13$ & $6220$ & $10394$ & $5$ & $22$--$30$ & $80\%$ & $65\%$
\\
$L_4$ & $18$ & $10584$ & $62164$ & $8$ & $12$--$14$ & $40\%$ & $35\%$
\\
$L_5$ & $12$ & $11772$ & $7902$ & $6$ & $15$--$17$ & $126\%$ & $98\%$
\\
$L_6$ & $22$ & $8640$ & $13299$ & $8$ & $16$--$23$ & $118\%$ & $98\%$
\\\hline
\end{tabular*}
\caption{Instance characteristics}
\label{tab:instances-characteristics}
\end{center}
\end{table}

The number $m$ of scenarios used to solve (2SA-$m$) is fixed to $20$, determined by preliminary experiments showing that it is a good trade-off between accuracy and tractability.
The time limit of the solver has been set to $120$ seconds.


\esgil{Faire tourner avec un peu plus de scénarios?}









\subsection{Demand distribution}
\label{sec:PDP:numerical-experiments:drawing-realization-of-demand}


For the sake of simplicity, in this section, we use index $k\in\range{K}$ to designated a pair $(t,i)\in\range{\horizon}\times\REF$.
We choose to model the distribution of demand $\bracket{\tilde{\va\demand}_1,\ldots,\tilde{\va\demand}_K}$ using the \distrib distribution defined as follow.


We define the \distrib distribution of order $K\ge2$, denoted $\cD\bracket{\gamma,\tilde{\demand}_1,\ldots,\tilde{\demand}_K}$, by the probability distribution on $\RR_+^K$ parametrized by $\gamma\in\bracket{0,1}$ and $K$ positive real numbers $\tilde{\demand}_1,\ldots,\tilde{\demand}_K$ such that $\bracket{\tilde{\va\demand}_1,\ldots,\tilde{\va\demand}_K}\sim\cD\bracket{\gamma,\tilde{\demand}_1,\ldots,\tilde{\demand}_K}$ if 
\begin{equation}
  \frac{1}{\tilde{\demand}_0}\bracket{\tilde{\va\demand}_1,\ldots,\tilde{\va\demand}_K}\sim\Dir\bracket{\alpha_1,\ldots,\alpha_K}
\end{equation}
with $\tilde{\demand}_0=\sum_{k=1}^K\tilde{\demand}_k$, $\alpha_0=\frac{1}{\gamma^2}-1$ and $\alpha_k=\frac{\tilde{\demand}_k}{\tilde{\demand}_0}\alpha_0$, for each $k\in\range{K}$.
(We remind that $\Dir\bracket{\alpha_1,\ldots,\alpha_K}$ designates the Dirichlet distribution and recall its definition and the main results in \cref{sec:reminders:gamma-and-dirichlet-distributions}.)


Thus, the \distrib distribution has the properties given is \cref{prop:demand-distribution:properties}.


\begin{prop}\label{prop:demand-distribution:properties}
Let $\gamma$ be a real number in $\bracket{0,1}$ and let $\tilde{\demand}_1,\ldots,\tilde{\demand}_K$ be $K$ positive number (with $K\ge2$).
Let $\bracket{\va\demand_1,\ldots,\va\demand_K}$ be a random vector with a \distrib distribution $\cD\bracket{\gamma,\tilde{\demand}_1,\ldots,\tilde{\demand}_K}$.
Then, the following properties holds.
\begin{enumerate}
  \item\label{enum:PDP:random-demand-property:expectation}
  Expectation of $\va\demand_k$ is equal to
  \begin{equation}
    e_k = \espe\sqbracket{\va\demand_k} = \tilde{\demand}_k\qquad\forall k\in\range{K}.
  \end{equation}
  \item\label{enum:PDP:random-demand-property:variance}
  Variance of $\va\demand_k$ is equal to
  \begin{equation}\label{eq:PDP:numerical-experiments:demand:variance}
    (\sigma_k)^2=\vari\sqbracket{\va\demand_k}=\gamma\,\tilde{\demand}_k\bracket{\tilde{\demand}_0-\tilde{\demand}_k}\qquad\forall k\in\range{K}.
  \end{equation}
  \item\label{enum:PDP:random-demand-property:constant-volume}
  Sum of components of the vector $\bracket{\va\demand_1,\ldots,\va\demand_K}$ does not depend on the realization and is equal to
  \begin{equation}
    \sum_{k=1}^{K}\va\demand_k = \tilde{\demand}_0\qquad\mbox{almost surely.}
  \end{equation}
  \item\label{enum:PDP:random-demand-property:past-conditional}
  The \distrib\ distribution keeps the same properties conditionally to the past realizations.
  More formally, let $m$ be an integer in $\range[1]{k-1}$. We denote $\va\demand_{(1)}=\bracket{\va\demand_1,\ldots,\va\demand_m}$, $\va\demand_{(2)}=\bracket{\va\demand_{m+1},\ldots,\va\demand_K}$ and $\demand_{(1)}=\bracket{\demand_1,\ldots,\demand_m}$ a fixed realization of $\va\demand_{(1)}$.
  Then, $\bracket{\va\demand_{(2)}|\va\demand_{(1)}=\demand_{(1)}}$ has a \distrib distribution $\cD\bracket{\gamma',\tilde{\demand}_{m+1},\ldots,\tilde{\demand}_K}$
  where $\gamma'$ is the unique positive solution of
  \begin{equation}\label{eq:PDP:random-demand-property:past-conditional:gamma}
    \frac{1}{\gamma'^2}-1 = \bracket{\frac{1}{\gamma^2}-1}\bracket{1-\frac{1^T\demand_{(1)}}{\tilde{\demand}_0}}
  \end{equation}
  where $1^T$ is the vector with length $m$ and all entries equal to 1. 
\end{enumerate}
\end{prop}


The parameters of the \distrib distribution used to generate demand are the historical forecast demand $\bar{\demand}_t^i$ for the $\tilde{\demand}_k$ and $\gamma$ is set equal to
\begin{equation}
  \gamma
  =
  v\frac
  {\sum_{k=1}^K\sqrt{\frac{\tilde{\demand}_0}{\bar{\demand_k}}-1}}
  {\sum_{k=1}^K\bracket{\frac{\tilde{\demand}_0}{\bar{\demand_k}}-1}}.
\end{equation}
The parameter $\gamma$ is defined from another parameter $v$ which we call \emph{volatility} and whose interpretation is easier.
Volatility gives the ratio between standard deviation and expectation of a random variable.
Such a choice\vl{which choice ?} enables the volatility of each demand to be close to $v$ as well as possible and will be justified in \cref{sec:PDP:numerical-experiments:instances:fitting-parameters}.
\vlil{une demi phrase disant de quoi on parle}
\cref{enum:PDP:random-demand-property:expectation} ensures that demand expectation is equal to the historical forecast demand and \cref{enum:PDP:random-demand-property:constant-volume} ensures that, as explained in \cref{chap:business-context}, total volume $\sum_{t,i}\va\demand_t^i$ of the forecast demand is constant over every possible outcomes.
\cref{enum:PDP:random-demand-property:past-conditional} ensures that demand distribution keeps its properties when part of demand is revealed.


Moreover, random variables with a \distrib\ distribution can be easily generated using \cref{proc:demand:initial-sampling} since most of modern programming languages has a generator of gamma distributed variables.


\begin{proc}\label{proc:demand:initial-sampling}
\emph{Generator of \distrib\ distribution $\cD\bracket{\gamma,\tilde{\demand}_1,\ldots,\tilde{\demand}_K}$}

\textbf{Step 1.} \emph{Initialize the procedure.}

Set $\tilde{\demand}_0 = \sum_{k=1}^K\tilde{\demand}_k$ and $\alpha_0 = \frac{1}{\gamma^2}-1$ and for $k=1,\ldots,K$, set $\alpha_k=\frac{\tilde{\demand}_k}{\tilde{\demand}_0}\alpha_0$.

\textbf{Step 2.} \emph{Generate Gamma realizations.}

For $k=1,\ldots,K$, draw a number $y_k$ from gamma distribution $\Gamma\bracket{\alpha_k,1}$.

\textbf{Step 3.} \emph{Normalize the realization.}

For $k=1,\ldots,K$, set $x_k=\frac{y_k}{\sum_{\ell=1}^K y_{\ell}}$.

\textbf{Step 4.} \emph{Return a sample of the \distrib\ distribution $\cD\bracket{\gamma,\tilde{\demand}_1,\ldots,\tilde{\demand}_K}$.}

For $k=1,\ldots,K$, set $d_k = x_k \tilde{\demand}_0$.
\end{proc}


Finally, \cref{proc:demand:initial-sampling} and \cref{enum:PDP:random-demand-property:past-conditional} of \cref{prop:demand-distribution:properties} enables to easily generate a realization of the demand when part of the demand is already revealed.



\subsection{Proofs of demand distribution results}
\label{sec:PDP:numerical-experiments:instances:proofs}
\vlil{titre à repenser : proof of properties of \distrib\ distibution}
\vlil{A mettre en annexe à terme ?}


In this section, we prove \cref{prop:demand-distribution:properties} and that \cref{proc:dirichlet:generation} returns a vector with a \distrib distribution.


\begin{proof}[Proof of \cref{prop:demand-distribution:properties}] 
Let $\gamma$ be a real number in $\bracket{0,1}$ and let $\tilde{\demand}_1,\ldots,\tilde{\demand}_K$ be $K$ positive number (with $K\ge2$).
Let $\bracket{\va\demand_1,\ldots,\va\demand_K}$ be a random variable with a \distrib distribution $\cD\bracket{\gamma,\tilde{\demand}_1,\ldots,\tilde{\demand}_K}$.
We recall that $\tilde{\demand}_0=\sum_{k=1}^K\tilde{\demand}_k$, that $\alpha_0=\frac{1}{\gamma^2}-1$ and that $\alpha_k=\frac{\tilde{\demand}_k}{\tilde{\demand}_0}\alpha_0$, for each $k\in\range{K}$.
\begin{enumerate}
\item Since $\frac{1}{\tilde{\demand}_0}\bracket{\va\demand_1,\ldots,\va\demand_K}$ has a Dirichlet distribution, we have for each $k\in\range{K}$
\begin{subequations}
\begin{align}
  \espe\sqbracket{\va\demand_k}
  &= \tilde{\demand}_0\espe\sqbracket{\frac{\va\demand_k}{\tilde{\demand}_0}}
  = \tilde{\demand}_0
  \frac{\alpha_k}{\alpha_0}
  && \mbox{(expectation of Dirichlet distribution)}
  \\
  &= \tilde{\demand_k}.
  && \mbox{(definition of $\alpha_k$)}
\end{align}
\end{subequations}
\item Since $\frac{1}{\tilde{\demand}_0}\bracket{\va\demand_1,\ldots,\va\demand_K}$ has a Dirichlet distribution, we have for each $k\in\range{K}$
\begin{subequations}
\begin{align}
  \vari\sqbracket{\va\demand_k}
  &= \tilde{\demand}_0^2\vari\sqbracket{\frac{\va\demand_k}{\tilde{\demand}_0}}
  = \tilde{\demand}_0^2
  \frac{\alpha_k\bracket{\alpha_0-\alpha_k}}{\alpha_0^2\bracket{\alpha_0+1}}
  && \mbox{(variance of Dirichlet distribution)}
  \\
  &= \tilde{\demand}_k^2 \bracket{\frac{\alpha_0}{\alpha_k}-1}\frac{1}{\alpha_0+1}
  && \mbox{(definition of $\alpha_k$)}
  \\
  &= \tilde{\demand}_k^2 \bracket{\frac{\tilde{\demand}_0}{\tilde{\demand}_k}-1}\gamma^2
  && \mbox{(definition of $\gamma$)}
  \\
  &= \gamma^2 \tilde{\demand}_k \bracket{\tilde{\demand}_0-\tilde{\demand}_k}.
\end{align}
\end{subequations}
\item Since $\frac{1}{\tilde{\demand}_0}\bracket{\va\demand_1,\ldots,\va\demand_K}$ has a Dirichlet distribution, we have $\sum_{k=1}^K \frac{\va\demand_k}{\tilde{\demand}_0}=1$ almost surely and the result follows.
\item Let $m$ be an integer in $\range[1]{K-1}$ and let $\demand_{(1)}$ be a vector of $m$ positive real numbers such that $1^T \demand_{(1)}<\tilde{\demand}_0$.
We denote $\va\demand_{(1)}=\bracket{\va\demand_1,\ldots,\va\demand_m}$ and $\va\demand_{(2)}=\bracket{\va\demand_{m+1},\ldots,\va\demand_K}$.

Since $\frac{1}{\tilde{\demand}_0}\bracket{\va\demand_1,\ldots,\va\demand_K}$ has a Dirichlet distribution and thanks to \cref{prop:dirichlet:conditional}, we have
\begin{equation}
\frac{1}{ 1- \frac{ 1^T\demand_{(1)} }{ \tilde{\demand}_0 } }
\left(
\frac{ \va\demand_{(2)} }{ \tilde{\demand}_0 }
\left|
\frac{ \va\demand_{(1)} }{ \tilde{\demand}_0 } = \frac{ \demand_{(1)} }{ \tilde{\demand}_0 }
\right.
\right)
\sim
\Dir\bracket{\alpha_{m+1},\ldots,\alpha_K}
\end{equation}
and then
\begin{equation}
\frac{1}{ \tilde{\demand}_0 - 1^T\demand_{(1)} }
\left(
\va\demand_{(2)}
\left|
\va\demand_{(1)} = \demand_{(1)}
\right.
\right)
\sim
\Dir\bracket{\alpha_{m+1},\ldots,\alpha_K}.
\end{equation}
Thus, the random vector
$
\left(
\va\demand_{(2)}
\left|
\va\demand_{(1)} = \demand_{(1)}
\right.
\right)
$
has a \distrib distribution $\cD\bracket{\gamma',\tilde{\demand}_{m+1},\ldots,\tilde{\demand}_K}$.
Indeed, assuming that $\gamma'$ is well-defined,
we have
\begin{equation}
  \tilde{\demand}_0' = \sum_{k=m+1}^K \tilde{\demand}_k = \tilde{\demand}_0 - 1^T\demand_{(1)}.
\end{equation}
%We have $\tilde{\demand}_0' = \tilde{\demand}_0 - 1^T\demand_{(1)} = \sum_{k=m+1}^K \va\demand_k$, almost surely.
Moreover,
\begin{equation}
  \alpha_0'
  = \bracket{\frac{1}{\gamma'^2}-1}
  = \bracket{\frac{1}{\gamma^2}-1}\bracket{1-\frac{1^T\demand_{(1)}}{\tilde{\demand}_0}}
  = \bracket{\frac{1}{\gamma^2}-1}\frac{\tilde{\demand}_0'}{\tilde{\demand}_0}
  = \frac{\tilde{\demand}_0'}{\tilde{\demand}_0}\alpha_0
\end{equation}
and
\begin{equation}
  \alpha_k' = \frac{\tilde{\demand}_k}{\tilde{\demand}_0'}\alpha_0' = \alpha_k\quad\forall k\in\range[m+1]{K}.
\end{equation}

Let prove that $\gamma'$ is well-defined.
Existence and uniqueness are straightforward since $\gamma'$ must be positive and since $0<\gamma<1$.
\cref{eq:PDP:random-demand-property:past-conditional:gamma} is equivalent to
$\gamma'^2 = \frac{\gamma^2}{\bracket{1-a}+a\gamma^2}$ with $a = \frac{1^T\demand_{(1)}}{\tilde{\demand}_0}$.
Then, it is sufficient to prove that $\frac{y}{\bracket{1-a}+ay}<1$ for any value of $\bracket{a,y}\in\bracket{0,1}^2$ which can be done studying the function $y\mapsto\frac{y}{\bracket{1-a}+ay}$ with a fixed $a\in\bracket{0,1}$.
\end{enumerate}
\end{proof}


We now prove that \cref{proc:demand:initial-sampling} returns a vector with a \distrib distribution.


\begin{proof}[Proof of \cref{proc:demand:initial-sampling}]
According to \cref{proc:dirichlet:generation} given in \cref{sec:reminders:gamma-and-dirichlet-distributions} for generating random realization of Dirichlet distributions, we know that step 2 and 3 produce a vector $\bracket{x_1,\ldots,x_K}$ with a Dirichlet distribution $\Dir\bracket{\alpha_1,\ldots,\alpha_K}$.
Thus, step 4 produces a vector $d$ such that $\frac{1}{\tilde{\demand}_0}\bracket{\demand_1,\ldots,\demand_K}$ is generated from a Dirichlet distribution $\Dir\bracket{\alpha_1,\ldots,\alpha_K}$ with $\tilde{\demand}_0 = \sum_{k=1}^K\tilde{\demand}_k$ and $\alpha_0 = \frac{1}{\gamma^2}-1$ and $\alpha_k=\frac{\tilde{\demand}_k}{\tilde{\demand}_0}\alpha_0$, for $k\in\range{K}$.
So \cref{proc:demand:initial-sampling} returns a vector with a \distrib distribution $\cD\bracket{\gamma,\tilde{\demand}_1,\ldots,\tilde{\demand}_K}$.
\end{proof}




% \subsection{Probabilistic model properties}
% \label{sec:PDP:numerical-experiments:probabilistic-model-properties}


% The random demand has a distribution $\cD\bracket{\gamma,\bracket{\demand_t^i}_{t,i}}$ which satisfies the following properties.
% \begin{enumerate}
%   \item\label{enum:PDP:random-demand-property:expectation} Demand's expectation is equal to its historical value:
%   \begin{equation}
%     \espe\sqbracket{\va\demand_t^i} = \tilde{\demand}_t^i\qquad\forall t\in\range{T},\ \forall i\in\REF.
%   \end{equation}
%   \item\label{enum:PDP:random-demand-property:constant-volume} Demand's total volume does not depend on the realization:
%   \begin{equation}
%     \sum_{t=1}^{\horizon}\sum_{i\in\REF}\va\demand_t^i = \sum_{t=1}^{\horizon}\sum_{i\in\REF}\tilde{\demand}_t^i\qquad\mbox{almost surely.}
%   \end{equation}
%   \item\label{enum:PDP:random-demand-property:variance} Demand's variance is equal to
%   \begin{equation}\label{eq:PDP:numerical-experiments:demand:variance}
%     (\sigma_t^i)^2=\vari\sqbracket{\va\demand_t^i}=\gamma\,\tilde{\demand}_t^i\sum_{\bracket{j,\tau}\ne\bracket{i,t}}\tilde{\demand}_{\tau}^j\qquad\forall t\in\range{T},\ \forall i\in\REF.
%   \end{equation}
%   \item\label{enum:PDP:random-demand-property:easy-simulation} It is easy to simulate.
%   \item\label{enum:PDP:random-demand-property:past-conditional} It keeps the same properties conditionally to the past realizations.
% \end{enumerate}


% As explained in \cref{chap:business-context}, total volume $\sum_{t,i}\va\demand_t^i$ of the forecast demand is assumed to be constant over every possible outcomes (\cref{enum:PDP:random-demand-property:constant-volume}).
% Since we want that demand's expectation is equal to its historical value (\cref{enum:PDP:random-demand-property:expectation}), \cref{enum:PDP:random-demand-property:variance} is a consequence of the model.
% The parameter $\gamma$ in expression~\eqref{eq:PDP:numerical-experiments:demand:variance} is defined from another parameter $v$ which we call \emph{volatility} and whose interpretation is easier.
% Volatility gives the ratio between standard deviation and expectation of a random variable.
% Then $\gamma$ is chosen as follow:
% \begin{equation}
%   \gamma
%   =
%   v\frac
%   {\sum_{k=1}^K\sqrt{\frac{\tilde{\demand}_0}{\bar{\demand_k}}-1}}
%   {\sum_{k=1}^K\bracket{\frac{\tilde{\demand}_0}{\bar{\demand_k}}-1}}
% \end{equation}
% This choice enables to the volatility of each demand to be close to $v$ and will be justified in \cref{}.
% As we will see, \cref{enum:PDP:random-demand-property:easy-simulation} and \cref{enum:PDP:random-demand-property:past-conditional} are also consequences of the model.


% \cref{proc:demand:initial-sampling} describes a generator of random variables having the properties given in \cref{sec:PDP:numerical-experiments:probabilistic-model-properties}.
% \cref{enum:PDP:random-demand-property:easy-simulation} is straightforward since most of modern programming languages has a generator of gamma distributed variables.
% \cref{thm:acuracy:proc:demand:initial-sampling} proves the accuracy of \crefrange{enum:PDP:random-demand-property:expectation}{enum:PDP:random-demand-property:variance} and \cref{prop:dirichlet:conditional} proves the accuracy of \cref{enum:PDP:random-demand-property:past-conditional}.


% \begin{thm}\label{thm:acuracy:proc:demand:initial-sampling}
% For any $\gamma\in\bracket{0,1}$ and any $\tilde{\demand}_1,\ldots,\tilde{\demand}_K$ positive, \cref{proc:demand:initial-sampling} draws a realization $\bracket{\demand_1,\ldots,\demand_K}$ from the distribution of the random vector $\bracket{\va\demand_1,\ldots,\va\demand_K}$ with
% \begin{subequations}
%   \begin{align+}
%     \sum_{k=1}^K \va\demand_k &= \sum_{k=1}^K \tilde{\demand}_k && \mbox{almost surely},
%     \\
%     \espe\sqbracket{\va\demand_k} &= \tilde{\demand}_k && \forall k\in\range{K},
%     \\
%     \vari\sqbracket{\va\demand_k} &= \gamma^2\bar{\demand_k}\bracket{\tilde{\demand}_0-\tilde{\demand}_k} && \forall k\in\range{K}.
%     \label{eq:dirichlet:procedure:variance}
%   \end{align+}
% \end{subequations}
% \end{thm}


% \begin{proof}
% We set $\tilde{\demand}_0$ and $\alpha_0,\ldots,\alpha_K$ as in step 1.
% We have
% \begin{equation}
%   \sum_{k=1}^K \alpha_k = \alpha_0 \sum_{k=1}^K\frac{\bar{\demand_k}}{\tilde{\demand}_0} = \alpha_0.
% \end{equation}
% According to \cref{proc:dirichlet:generation} given in \cref{sec:reminders:gamma-and-dirichlet-distributions} for generating random realization of Dirichlet distributions, we know that step 2 and 3 produced a realization $\bracket{x_1,\ldots,x_K}$ of $\Dir\bracket{\alpha}$.
% Setting $\bracket{\demand_1,\ldots,\demand_K}$ as in step 4, we have a realization of the random vector $\bracket{\va\demand_1,\ldots,\va\demand_K}$ with
% \begin{align}
%   \sum_{k=1}^K \va\demand_k
%   &= \tilde{\demand}_0 \sum_{k=1}^K \va x_k
%   = \tilde{\demand}_0
%   = \sum_{k=1}^K \tilde{\demand}_k
%   && \mbox{almost everywhere},
%   \\
%   \espe\sqbracket{\va\demand_k}
%   &= \tilde{\demand}_0\espe\sqbracket{\va x_k}
%   = \tilde{\demand}_0\ \frac{\alpha_k}{\alpha_0}
%   = \tilde{\demand}_k
%   && \forall k\in\range{K}.
% \end{align}
% Finally, computing the variance of each variable $\va\demand_k$ gives
% \begin{subequations}
% \begin{align}
%   \vari\sqbracket{\va\demand_k}
%   &= \tilde{\demand}_0^2\vari\sqbracket{\va x_k}
%   = \tilde{\demand}_0^2
%   \frac{\alpha_k\bracket{\alpha_0-\alpha_k}}{\alpha_0^2\bracket{\alpha_0+1}}
%   && \mbox{(variance of Dirichlet distribution)}
%   \\
%   &= \tilde{\demand}_k^2 \bracket{\frac{\alpha_0}{\alpha_k}-1}\frac{1}{\alpha_0+1}
%   && \mbox{(definition of $\alpha_k$)}
%   \\
%   &= \tilde{\demand}_k^2 \bracket{\frac{\bar{\demand}_0}{\tilde{\demand}_k}-1}\gamma^2
%   && \mbox{(definition of $\gamma$)}
%   \\
%   &= \gamma^2 \tilde{\demand}_k \bracket{\bar{\demand}_0-\tilde{\demand}_k}
% \end{align}
% \end{subequations}
% which conclude the proof.
% \end{proof}




% Before presenting the probabilistic model, we introduce the \emph{coefficient of variation} also known as the \emph{relative standard deviation} \cite{Everitt1998}.
% \begin{defn}
% The coefficient of variation $\CV\sqbracket{\va X}$ of a random variable $\va X$ is defined as the ratio of the standard deviation $\sigma\bracket{\va X}$ to the mean $\espe\sqbracket{\va X}$:
% \begin{equation}
%   \CV\sqbracket{\va X} = \frac{\sigma\bracket{\va X}}{\espe\sqbracket{\va X}}.
% \end{equation}
% \end{defn}


% As explained in \cref{chap:business-context}, the global volume $\sum_{t,i}\va\demand_t^i$ of the forecast demand is assumed to be constant over every possible outcomes.
% Except the previous assumption, we did not obtain a precise description of the real probabilistic model used by the client.
% We choose a model with few parameters even if it is less realistic.
% This choice enables to easily see the impact of each parameter.
% Moreover, methods developed in this thesis being independent from the choice of probabilistic model, they can be apply with more complex model.
% We obtain the demand via Dirichlet distributions whose parameters are computed from two values.
% (See \cref{sec:reminders:gamma-and-dirichlet-distributions} for reminders about Dirichlet distributions.)
% \begin{itemize}
%   \item A ``volatility'' $v$ chosen in $\crbracket{20\%, 50\%, 80\%}$.
%   It represents the accuracy of the forecast demand.
%   The bigger is $v$, the less precise is the forecast demand.

%   For each period $t$ and each item $i$, the coefficient of variation of demand $\va\demand_t^i$ must satisfy as well as possible $\CV\sqbracket{\va\demand_t^i}=v$.
%   If, due to other constraints, it cannot be equal to the volatility $v$, it must be greater for the items and periods with low expected demand.
%   Indeed, in practice, we have more accuracy in proportion on best-sellers than on short series.
%   \item A number of weeks $\tau$ chosen in $\crbracket{4,7,13}$.
%   The total volume of the forecast demand is constant over the week 1 to $\tau$, then during the week $\tau+1$ to $2\tau$, etc.
%   The chosen values represent a month, half a quarter and a complete quarter.
% \end{itemize}
%Details about the distributions and how its parameters are computed are given in Section~\cref{sec:PDP:numerical-experiments:dirichlet}.



% \subsection{Generating randomness}
% \label{sec:PDP:numerical-experiments:dirichlet}


% % As explained in Chapter~\cref{chap:business-context}, the global volume of the forecast demand is constant over every possible outcomes.
% % Thus, we turn to Dirichlet distributions to generate the possible outcomes of demand.
% % Reminders about Gamma and Dirichlet distributions are given in \cref{sec:reminders:gamma-and-dirichlet-distributions}.
% We first expose the procedure to generate samples of demand at the beginning of the simulation.
% Then we adapt the procedure to generate sample knowing the past realizations of the demand.
% finally, we present how to fit the parameters of the procedure to the probabilistic model.
% % Then, we remind the definition and the classical properties of Dirichlet distributions, explains how the parameters are computed for the procedure and how these properties are used during the simulation.

% For the sake of simplicity, only in this section, we use index $k\in\range{K}$ to designated a pair $(t,i)$.


% \medskip


%\subsubsection{Procedure to generate sample of demand}


%\textbf{Hypothesis.} We assume that every demand has a positive mean and that there are at least two demands is the set.

% For any $\gamma\in\bracket{0,1}$ and any $\tilde{\demand}_1,\ldots,\tilde{\demand}_K$ positive, we define the following procedure.
% \begin{proc}\label{proc:demand:initial-sampling}
% \emph{Initial Sampling}

% \textbf{Step 1.} \emph{Initialize the procedure.}
% Set
% %\begin{subequations}
% %  \begin{align+}
% %    \tilde{\demand}_0 &= \sum_{k=1}^K\tilde{\demand}_k
% %    \\
% %    \gamma &= \min \bracket{1,\
% %    \frac
% %    {\sum_{k=1}^K\sqrt{\frac{\tilde{\demand}_0-\tilde{\demand}_k}{\tilde{\demand}_k}}}{\sum_{k=1}^K\frac{\tilde{\demand}_0-\tilde{\demand}_k}{\tilde{\demand}_k}}\ v}
% %    \\
% %    \alpha_0 &= \frac{1}{\gamma^2}-1
% %  \end{align+}
% %\end{subequations}
% \begin{equation}
%     \tilde{\demand}_0 = \sum_{k=1}^K\tilde{\demand}_k
%     \ \mbox{and}\ 
%     \alpha_0 = \frac{1}{\gamma^2}-1.
% \end{equation}
% For $k=1,\ldots,K$, set $\alpha_k=\frac{\tilde{\demand}_k}{\tilde{\demand}_0}\alpha_0$.

% \textbf{Step 2.} \emph{Generate Gamma realizations.}
% For $k=1,\ldots,K$, draw a number $y_k$ from gamma distribution $\Gamma\bracket{\alpha_k,1}$.

% \textbf{Step 3.} \emph{Normalize the realization.}
% For $k=1,\ldots,K$, set $x_k=\frac{y_k}{\sum_{\ell=1}^K y_{\ell}}$.

% \textbf{Step 4.} \emph{Return a sample of demand.}
% For $k=1,\ldots,K$, set $d_k = x_k \tilde{\demand}_0$.
% \end{proc}

% \begin{thm}
% For any $\gamma\in\bracket{0,1}$ and any $\tilde{\demand}_1,\ldots,\tilde{\demand}_K$ positive, \cref{proc:demand:initial-sampling} produces a realization $\bracket{\demand_1,\ldots,\demand_K}$ of the random vector $\bracket{\va\demand_1,\ldots,\va\demand_K}$ with
% \begin{subequations}
%   \begin{align+}
%     \sum_{k=1}^K \va\demand_k &= \sum_{k=1}^K \tilde{\demand}_k && \mbox{almost surely},
%     \\
%     \espe\sqbracket{\va\demand_k} &= \tilde{\demand}_k && \forall k\in\range{K},
%     \\
%     \vari\sqbracket{\va\demand_k} &= \gamma^2\bar{\demand_k}\bracket{\tilde{\demand}_0-\tilde{\demand}_k} && \forall k\in\range{K}.
%     \label{eq:dirichlet:procedure:variance}
%   \end{align+}
% \end{subequations}
% \end{thm}


% \begin{proof}
% We set $\tilde{\demand}_0$ and $\alpha_0,\ldots,\alpha_K$ as in step 1.
% We have
% \begin{equation}
%   \sum_{k=1}^K \alpha_k = \alpha_0 \sum_{k=1}^K\frac{\bar{\demand_k}}{\tilde{\demand}_0} = \alpha_0.
% \end{equation}
% According to \cref{proc:dirichlet:generation} given in \cref{sec:reminders:gamma-and-dirichlet-distributions} for generating random realization of Dirichlet distributions, we know that step 2 and 3 produced a realization $\bracket{x_1,\ldots,x_K}$ of $\Dir\bracket{\alpha}$.
% Setting $\bracket{\demand_1,\ldots,\demand_K}$ as in step 4, we have a realization of the random vector $\bracket{\va\demand_1,\ldots,\va\demand_K}$ with
% \begin{align}
%   \sum_{k=1}^K \va\demand_k
%   &= \tilde{\demand}_0 \sum_{k=1}^K \va x_k
%   = \tilde{\demand}_0
%   = \sum_{k=1}^K \tilde{\demand}_k
%   && \mbox{almost everywhere},
%   \\
%   \espe\sqbracket{\va\demand_k}
%   &= \tilde{\demand}_0\espe\sqbracket{\va x_k}
%   = \tilde{\demand}_0\ \frac{\alpha_k}{\alpha_0}
%   = \tilde{\demand}_k
%   && \forall k\in\range{K}.
% \end{align}
% Finally, computing the variance of each variable $\va\demand_k$ gives
% \begin{subequations}
% \begin{align}
%   \vari\sqbracket{\va\demand_k}
%   &= \tilde{\demand}_0^2\vari\sqbracket{\va x_k}
%   = \tilde{\demand}_0^2
%   \frac{\alpha_k\bracket{\alpha_0-\alpha_k}}{\alpha_0^2\bracket{\alpha_0+1}}
%   && \mbox{(variance of Dirichlet distribution)}
%   \\
%   &= \tilde{\demand}_k^2 \bracket{\frac{\alpha_0}{\alpha_k}-1}\frac{1}{\alpha_0+1}
%   && \mbox{(definition of $\alpha_k$)}
%   \\
%   &= \tilde{\demand}_k^2 \bracket{\frac{\tilde{\demand}_0_0}{\tilde{\demand}_k}-1}\gamma^2
%   && \mbox{(definition of $\gamma$)}
%   \\
%   &= \gamma^2 \tilde{\demand}_k \bracket{\tilde{\demand}_0_0-\tilde{\demand}_k}
% \end{align}
% \end{subequations}
% which conclude the proof.
% \end{proof}



% During the simulation, past demands are known.
% In order to generate a new sample of scenarios using this information, we relies on \cref{prop:dirichlet:conditional}.
% For a fixed $m\in\range{K}$, if demands $\va\demand_1,\ldots,\va\demand_m$ are already know and are equal to $\demand_1,\ldots,\demand_m$, \cref{proc:demand:sampling-from-m} describes a generator of random variables having the properties given in \cref{sec:PDP:numerical-experiments:probabilistic-model-properties}.


% \begin{proc}\label{proc:demand:sampling-from-m}
% \emph{Generating sample of demand according to distribution}

% \textbf{Step 1.} \emph{Initialize the procedure.}

% Set $\tilde{\demand}_0 = \sum_{k=1}^K\tilde{\demand}_k$ and $\alpha_0 = \frac{1}{\gamma^2}-1$ and for $k=1,\ldots,K$, set $\alpha_k=\frac{\tilde{\demand}_k}{\tilde{\demand}_0}\alpha_0$.

% \textbf{Step 2.} \emph{Generate Gamma realizations.}

% For $k=1,\ldots,K$, draw a number $y_k$ from gamma distribution $\Gamma\bracket{\alpha_k,1}$.

% \textbf{Step 3.} \emph{Normalize the realization.}

% For $k=1,\ldots,K$, set $x_k=\frac{y_k}{\sum_{\ell=1}^K y_{\ell}}$.

% \textbf{Step 4.} \emph{Return a sample of demand.}

% For $k=1,\ldots,K$, set $d_k = x_k \tilde{\demand}_0$.
% \end{proc}



% \begin{prop}\label{prop:dirichlet:conditional}
%   Let $\va x=\bracket{\va x_1,\ldots,\va x_K}\sim \Dir\bracket{\alpha_1,\ldots,\alpha_K}$ and $m\in\range[1]{k-1}$.
%   We denote $\va x_{(1)}=\bracket{\va x_1,\ldots,\va x_m}$ and $\va x_{(2)}=\bracket{\va x_{m+1},\ldots,\va x_K}$.
%   So $\va x_{(2)}|\va x_{(1)}=x_{(1)}$ has a scaled Dirichlet distribution, or equivalently,
%   $$
%   \frac{1}{1-1^T x_{(1)}} \bracket{\va x_{(2)}|\va x_{(1)}=x_{(1)}}
%   \sim
%   \Dir\bracket{\alpha_{m+1},\ldots,\alpha_K}
%   $$
%   where $1^T$ is the vector with length $m$ and all entries equal to 1.
% \end{prop}

% Indeed, knowing the realization of $\bracket{\va\demand_1,\ldots,\va\demand_m}$ is equivalent to know the realization of $\bracket{\va x_1,\ldots,\va x_m}$ and then, we can use the same procedure to generate a new sample of demand.

% \begin{proof}[Proof of \cref{prop:dirichlet:conditional}]
% \cite{Kotz2000}
% \end{proof}

% \esgil{Write proof of \cref{prop:dirichlet:conditional} or find it in a book}



\subsection{Fitting the parameters to the probabilistic model}
\label{sec:PDP:numerical-experiments:instances:fitting-parameters}


When proposing a model for demand distribution, we face many objectives.
First demand expectation should be equal to its historical forecast which is ensured by \cref{enum:PDP:random-demand-property:expectation} of \cref{prop:demand-distribution:properties}.
Second, a main hypothesis of the model that cumulative sum of demand does not depend of the realization.
The chosen distribution ensures this properties thanks to \cref{enum:PDP:random-demand-property:constant-volume}.
Last, every company do not have the same uncertainty on forecast demand.
For example, some companies may have more historical data to rely on to produce forecast or some sectors may rely on firm command whereas other cannot.
Thus our model should be able to control the volatility $v$ on forecast demand.


For the sake of simplicity, we choose a unique parameter $v$ which represents the ratio between standard deviation and expectation of a random variable and which can be easily interpret by companies.
Thus, we look for $\gamma\in\bracket{0,1}$ which minimizes
\begin{equation}
  \norm{\bracket{\frac{\sigma_1}{e_1},\ldots,\frac{\sigma_K}{e_K}}-v.1_{(K)}}_2
\end{equation}
where $e_k$ and $\sigma_k$ are defined in \cref{prop:demand-distribution:properties} and $1_{(K)}$ is the vector with length $K$ and all entries equal to 1.
Note that the norm $\norm{\ .\ }_2$ has been chosen.
One advantage is the close formula for the value of $\gamma$ (see \cref{prop:demand:generation:gamma-choice}).
If $\norm{\ .\ }_1$ or $\norm{\ .\ }_{\infty}$ had been chosen, finding the best $\gamma$ would be done with classical linearization methods and the use of a linear solver.




% The objective is to generate samples of demand $\bracket{\va\demand_1,\ldots,\va\demand_K}$ such that:
% \begin{subequations}
%   \begin{align}
%     \sum_{k=1}^K \va\demand_k &= \sum_{k=1}^K \tilde{\demand}_k && \mbox{almost everywhere},
%     \label{eq:demand:generation:constant-sum}
%     \\
%     \espe\sqbracket{\va\demand_k} &= \tilde{\demand}_k && \forall k\in\range{K},
%     \label{eq:demand:generation:mean}
%     \\
%     \CV\sqbracket{\va\demand_t^i} &= v && \forall k\in\range{K},
%     \label{eq:demand:generation:variance}
%   \end{align}
% \end{subequations}
% where $v\in\bracket{0,1}$ is the volatility defined in Section~\cref{sec:PDP:numerical-experiments:probabilistic-model}.
%We first expose the procedure, then justify it and explain why the three properties can be exactly reached.


% However, the proposed procedure does not generate random variables satisfying simultaneously constraints \eqref{eq:demand:generation:constant-sum}, \eqref{eq:demand:generation:mean} and \eqref{eq:demand:generation:variance}.
% Thus, as explained in the \cref{sec:PDP:numerical-experiments:probabilistic-model}, constraints \eqref{eq:demand:generation:constant-sum} and \eqref{eq:demand:generation:mean} are first satisfied and constraint \eqref{eq:demand:generation:variance} is approximate as well as possible.
% \cref{prop:demand:generation:gamma-choice} gives a possible choice of parameter $\gamma$ for the \cref{proc:demand:initial-sampling}.

% For any $\gamma\in\bracket{0,1}$ and for each index $k$, we denote by $v_k\bracket{\gamma}=\CV\sqbracket{\va\demand_k}$ the coefficient of variation of the random variable $\va\demand_k$ whose realization is produced by \cref{proc:demand:initial-sampling}.
% % \begin{equation}
% %   v_k
% %   = \frac{\sqrt{\vari\sqbracket{\va\demand_k}}}{\tilde{\demand}_k}
% %   = \gamma\sqrt{\frac{\tilde{\demand}_0}{\bar{\demand_k}}-1}
% % \end{equation}
% % which differs from the objective of a single volatility for every index.
% Thus, we look for $\gamma\in\bracket{0,1}$ which minimizes
% \begin{equation}
%   \norm{\bracket{v_1(\gamma')-v,\ldots,v_K(\gamma')-v}}_2.
% \end{equation}
% Note that the norm $\norm{\ .\ }_2$ has been chosen.
% One advantage is the close formula for the value of $\gamma$ (see \cref{prop:demand:generation:gamma-choice}).
% If $\norm{\ .\ }_1$ or $\norm{\ .\ }_{\infty}$ had been chosen, finding the best $\gamma$ would be done with classical linearization methods and the use of a linear solver.


\begin{prop}\label{prop:demand:generation:gamma-choice}
For any $v\in\bracket{0,1}$ and any $\tilde{\demand}_1,\ldots,\tilde{\demand}_K$ positive,
\begin{equation}
  \gamma
  =
  v\frac
  {\sum_{k=1}^K\sqrt{\frac{\tilde{\demand}_0}{\bar{\demand_k}}-1}}
  {\sum_{k=1}^K\bracket{\frac{\tilde{\demand}_0}{\bar{\demand_k}}-1}}
\end{equation}
minimize the quantity
$\norm{\bracket{\frac{\sigma_1}{e_1},\ldots,\frac{\sigma_K}{e_K}}-v.1_{(K)}}_2$.
\end{prop}



%Before justifying the procedure just note that the objective formulation of the variance given in Section~\cref{sec:PDP:numerical-experiments:historical-data} does not match exactly to the formulation~\eqref{eq:dirichlet:procedure:variance} find at the end of the procedure. However, we succeed in approaching the other objective since the bigger is the demand, the lower is the volatility $v_k=\frac{\sqrt{\vari\sqbracket{\va\demand_k}}}{\tilde{\demand}_k} = \gamma\sqrt{\frac{\tilde{\demand}_0}{\bar{\demand_k}}-1}$.


% We first assume that $\gamma$ is an external parameter of the algorithm and justify it with this hypothesis. Setting $\alpha_0,\ldots,\alpha_K$ as in step 1, we have:
% \begin{equation}
%   \sum_{k=1}^K \alpha_k = \alpha_0 \sum_{k=1}^K\frac{\bar{\demand_k}}{\tilde{\demand}_0} = \alpha_0
% \end{equation}
% According to the procedure previously described for generating random realization of Dirichlet distribution, we know that step 2 and 3 produced a realization $\bracket{x_1,\ldots,x_K}$ of $\Dir\bracket{\alpha}$. Setting $\bracket{\demand_1,\ldots,\demand_K}$ as in step 4, we have a realization of the random vector $\bracket{\va\demand_1,\ldots,\va\demand_K}$ with:
% \begin{align}
%   \sum_{k=1}^K \va\demand_k
%   &= \tilde{\demand}_0 \sum_{k=1}^K \va x_k
%   = \tilde{\demand}_0
%   = \sum_{k=1}^K \tilde{\demand}_k
%   && \mbox{almost everywhere},
%   \\
%   \espe\sqbracket{\va\demand_k}
%   &= \tilde{\demand}_0\espe\sqbracket{\va x_k}
%   = \tilde{\demand}_0\ \frac{\alpha_k}{\alpha_0}
%   = \tilde{\demand}_k
%   && \forall k\in\range{K}.
% \end{align}
% Finally, computing the variance of each variable $\va\demand_k$ gives:

% \begin{subequations}
% \begin{align}
%   \vari\sqbracket{\va\demand_k}
%   &= \tilde{\demand}_0^2\vari\sqbracket{\va x_k}
%   = \tilde{\demand}_0^2
%   \frac{\alpha_k\bracket{\alpha_0-\alpha_k}}{\alpha_0^2\bracket{\alpha_0+1}}
%   && \mbox{(variance of Dirichlet distribution)}
%   \\
%   &= \tilde{\demand}_k^2 \bracket{\frac{\alpha_0}{\alpha_k}-1}\frac{1}{\alpha_0+1}
%   && \mbox{(definition of $\alpha_k$)}
%   \\
%   &= \tilde{\demand}_k^2 \bracket{\frac{\tilde{\demand}_0}{\tilde{\demand}_k}-1}\gamma^2
%   && \mbox{(definition of $\gamma$)}
%   \\
%   &= \gamma^2 \tilde{\demand}_k \bracket{\bar{\demand}_0-\tilde{\demand}_k}
% \end{align}
% \end{subequations}


\begin{proof}
Let $v$ be a real number in $\bracket{0,1}$ and $\tilde{\demand}_1,\ldots,\tilde{\demand}_K$ be positive real numbers.
For each index $k$, \cref{prop:demand-distribution:properties} gives
\begin{equation}
  \frac{\sigma_k}{e_k}
  = \frac{\sqrt{\vari\sqbracket{\va\demand_k}}}{\espe\sqbracket{\va\demand_k}}
  = \gamma\sqrt{\frac{\tilde{\demand}_0}{\bar{\demand_k}}-1}.
\end{equation}

Then, finding $\gamma'\in\bracket{0,1}$ which minimizes $\norm{\bracket{\frac{\sigma_1}{e_1},\ldots,\frac{\sigma_K}{e_K}}-v.1_{(K)}}_2$ is equivalent to look for the minimizer on $\bracket{0,1}$ of the function
\begin{subequations}
\begin{align}
  f\bracket{\gamma'}
  &= \sum_{k=1}^K \bracket{\gamma'\sqrt{\frac{\tilde{\demand}_0}{\bar{\demand_k}}-1}-v}^2
  \\
  % &= \sum_{k=1}^K
  % \bracket{
  % \bracket{\frac{\tilde{\demand}_0}{\bar{\demand_k}}-1}\gamma'^2
  % - 2v\sqrt{\frac{\tilde{\demand}_0}{\bar{\demand_k}}-1}\gamma'
  % + v^2
  % }
  % \\
  &= \sum_{k=1}^K\bracket{\frac{\tilde{\demand}_0}{\bar{\demand_k}}-1}\gamma'^2
  - 2v\bracket{\sum_{k=1}^K\sqrt{\frac{\tilde{\demand}_0}{\bar{\demand_k}}-1}}\gamma'
  + K v^2
\end{align}
\end{subequations}
$f$ is a quadratic function and reach its minimum for
\begin{equation}
  \gamma
  =
  v\frac
  {\sum_{k=1}^K\sqrt{\frac{\tilde{\demand}_0}{\bar{\demand_k}}-1}}
  {\sum_{k=1}^K\bracket{\frac{\tilde{\demand}_0}{\bar{\demand_k}}-1}}
\end{equation}
$\bracket{\frac{\demand_1}{\tilde{\demand}_0},\ldots,\frac{\demand_K}{\tilde{\demand}_0}}$ being in the interior of the simplex, according to \cref{lem:PDP:numerical-experiments:interior}, we have
\begin{equation}
  0 <
  \frac
  {\sum_{k=1}^K\sqrt{\frac{\tilde{\demand}_0}{\bar{\demand_k}}-1}}
  {\sum_{k=1}^K\bracket{\frac{\tilde{\demand}_0}{\bar{\demand_k}}-1}}
  \le
  \frac{1}{\sqrt{K-1}}.
\end{equation}
Since $v\in\bracket{0,1}$, we have $\gamma\in\bracket{0,1}$ and the result follows.
\end{proof}



\begin{lem}\label{lem:PDP:numerical-experiments:interior}
Let $K$ be an integer greater than 1.
We define
\begin{equation}
  \delta^{K-1} = \crbracket{\bracket{x_1,\ldots,x_K}\in\bracket{0,1}^K \bigg| \sum_{k=1}^K x_k = 1}
\end{equation}
and
\begin{equation}
  \begin{array}{rccl}
  g: & \delta^{K-1} & \rightarrow & \RR_+ \\
     & x & \mapsto & \frac{\sum_{k=1}^K\sqrt{\frac{1}{x_k}-1}}{\sum_{k=1}^K\bracket{\frac{1}{x_k}-1}}
  \end{array}
\end{equation}
Then, $\max g$ exists and is equal to $\frac{1}{\sqrt{K-1}}$
\end{lem}


\begin{proof}
For each index $k\in\range{K}$, we set
\begin{equation}
  y_k\bracket{x} = \frac{\frac{1}{x_k}-1}{\lambda\bracket{x}}
  \quad\mbox{with}\quad
  \lambda\bracket{x} = \sum_{\ell=1}^K\bracket{\frac{1}{x_{\ell}}-1}
  ,\quad\mbox{and}\quad 
  \mu\bracket{y} = \sum_{\ell=1}^K \sqrt{y_{\ell}}.
\end{equation}
Then we get
\begin{equation}
  g\bracket{x} = \frac{\sum_{k=1}^K\sqrt{\lambda\bracket{x}y_k\bracket{x}}}{\lambda\bracket{x}}
  = \frac{\mu\bracket{y\bracket{x}}}{\sqrt{\lambda\bracket{x}}}
  \le \frac{\sup_{y\in\delta^{K-1}}\mu\bracket{y}}{\sqrt{\inf_{x\in\delta^{K-1}}\lambda\bracket{x}}}.
\end{equation}
$\mu$ being concave and symmetric (\ie its value does not depend of the order of its arguments), we get
\begin{equation}
  \sup_{y\in\delta^{K-1}}\mu\bracket{y} = \mu\bracket{\frac{1}{K},\ldots,\frac{1}{K}} = \sqrt{K}.
\end{equation}
$\lambda$ being convex and symmetric, we get
\begin{equation}
  \inf_{x\in\delta^{K-1}}\lambda\bracket{x} = \lambda\bracket{\frac{1}{K},\ldots,\frac{1}{K}} = K\bracket{K-1}.
\end{equation}
Then, we have for each $x\in\delta^{K-1}$
\begin{equation}
  g\bracket{x} \le \frac{1}{\sqrt{K-1}}.
\end{equation}
Since $g\bracket{\frac{1}{K},\ldots,\frac{1}{K}}=\frac{1}{\sqrt{K-1}}$, the result follows.
\end{proof}


% \begin{rmq}
%   Actually, the previous proof shows that the maximum of $\gamma$ is reached for $\demand_k=\frac{\bar{\demand_k}}{K}$.
%   Thus, we can easily extend the definition of $\gamma$ for values of volatility $v\in\bracket{0,\sqrt{K-1}}$.
% \end{rmq}




\section{Numerical results}


\esgil{To do when result will be complete}

\begin{itemize}
  \item Results with backorder costs
  \item Results with fill rate service level constraint
\end{itemize}




\section{Reminders on Gamma and Dirichlet distributions}
\label{sec:reminders:gamma-and-dirichlet-distributions}



\subsection{Gamma distributions}

The \emph{gamma distribution} denoted by $\Gamma(k,\theta)$ is a family of continuous two-parameter probability distributions.
Its definition can be found in \cite[Appendix A]{Delmas2006}.
It is parametrized by a shape parameter $k>0$ and a scale parameter $\theta>0$.
Its support is $\RR_+$.

The gamma distribution has a probability density function with respect to Lebesgue measure on $\RR_+$ given by
\begin{equation}\label{eq:dirchlet:probability-density-function}
  f\bracket{x,k,\theta} = \frac{x^{k-1}e^{-\frac{x}{\theta}}}{ \theta^k\Gamma\bracket{k} }
\end{equation}
where the gamma function is expressed for any $z\in\RR_+^*$ by
\begin{equation}
  \Gamma\bracket{z} = \int_0^{\infty} x^{z-1}e^{-x} \diff x.
\end{equation}


\subsection{Dirichlet distributions}

We refer to \cite[Chapter 49]{Kotz2000} for the details of the proofs of classical results about Dirichlet distributions.


\subsubsection{Definition}


The \emph{Dirichlet distribution} denoted by $\Dir(\alpha)$ is a family of continuous multivariate probability distributions.
It is parametrized by a number of categories $K \ge 2$ (integer) and a vector $\alpha=\bracket{\alpha_1,\ldots,\alpha_K}\in\bracket{\RR_+^*}^K$ of positive reals called concentrations parameters.
Its support is a vector $x=\bracket{x_1,\ldots,x_K}\in\bracket{0,1}^K$ oh the $K-1$ simplex \ie such that $\sum_{k=1}^K x_k = 1$.

The Dirichlet distribution has a probability density function with respect to Lebesgue measure on the Euclidean space $\RR^{K-1}$ given by
\begin{equation}\label{eq:dirchlet:probability-density-function}
  f\bracket{x,\alpha} = \frac{1}{ \Beta\bracket{\alpha}}\prod_{k=1}^K x_k^{\alpha_k-1}.
\end{equation}
The normalizing constant is the multivariate beta function, which can be expressed in terms of the gamma function
\begin{equation}
  \Beta\bracket{\alpha} =
  \frac{ \prod_{k=1}^K \Gamma\bracket{\alpha_k} }
       { \Gamma\bracket{\sum_{k=1}^K \alpha_k} }
\end{equation}
where the gamma function is expressed for any $z\in\RR_+^*$ by
\begin{equation}
  \Gamma\bracket{z} = \int_0^{\infty} x^{z-1}e^{-x} \diff x.
\end{equation}


\subsubsection{Moments}


Let $\va x=\bracket{\va x_1,\ldots,\va x_K}\sim \Dir\bracket{\alpha}$.
Setting $\alpha_0=\sum_{k=1}^K\alpha_k$, the moments of the Dirichlet distribution are
\begin{subequations}\label{eq:dirchlet:moments}
  \begin{align}
    \espe\sqbracket{\va x_k} &= \frac{\alpha_k}{\alpha_0} && \forall k\in\range{K},
    \label{eq:dirchlet:moments:mean}
    \\
    \vari\sqbracket{\va x_k} &= \frac{\alpha_k\bracket{\alpha_0-\alpha_k}}{\alpha_0^2\bracket{\alpha_0+1}} && \forall k\in\range{K},
    \label{eq:dirchlet:moments:variance}
    \\
    \cova\sqbracket{\va x_k,\va x_{\ell}} &= \frac{-\alpha_k\alpha_{\ell}}{\alpha_0^2\bracket{\alpha_0+1}} && \forall k\ne\ell.
    \label{eq:dirchlet:moments:covariance}
  \end{align}
\end{subequations}


\subsubsection{Aggregation property}


The Dirichlet distribution has the aggregation property given by \cref{prop:dirichlet:aggregation}.

\begin{prop}\label{prop:dirichlet:aggregation}
  If $\va x=\bracket{\va x_1,\ldots,\va x_K}\sim \Dir\bracket{\alpha_1,\ldots,\alpha_K}$ then, if the random variables with index $k$ and $\ell$ are dropped from the vector and replaced by their sum,
  $$\va x=\bracket{\va x_1,\ldots,\va x_k+\va x_{\ell},\ldots,\va x_K}\sim \Dir\bracket{\alpha_1,\ldots,\alpha_k+\alpha_{\ell},\ldots,\alpha_K}$$
\end{prop}


\subsubsection{Conditional Dirichlet distribution}


The distribution of part of the variables of a Dirichlet conditionally to the other variable is a scalled Dirichlet distribution.


\begin{prop}\label{prop:dirichlet:conditional}
  Let $\va x=\bracket{\va x_1,\ldots,\va x_K}\sim \Dir\bracket{\alpha_1,\ldots,\alpha_K}$ and $m\in\range[1]{k-1}$.
  We denote $\va x_{(1)}=\bracket{\va x_1,\ldots,\va x_m}$ and $\va x_{(2)}=\bracket{\va x_{m+1},\ldots,\va x_K}$.
  So $\va x_{(2)}|\va x_{(1)}=x_{(1)}$ has a scaled Dirichlet distribution, or equivalently,
  $$
  \frac{1}{1-1^T x_{(1)}} \bracket{\va x_{(2)}|\va x_{(1)}=x_{(1)}}
  \sim
  \Dir\bracket{\alpha_{m+1},\ldots,\alpha_K}
  $$
  where $1^T$ is the vector with length $m$ and all entries equal to 1.
\end{prop}




\subsubsection{Generating Dirichlet distributed variables}


Realizations of the random vector $\va x=\bracket{\va x_1,\ldots,\va x_K}\sim\Dir\bracket{\alpha_1,\ldots,\alpha_K}$ can be get from a source of Gamma distributed random variates using \cref{proc:dirichlet:generation} described in~\cite{Frigyik2010}.


\begin{proc}\label{proc:dirichlet:generation}
\emph{Generating Dirichlet distributed variables}

\textbf{Step 1.} \emph{Generate Gamma realizations.} For $k=1,\ldots,K$, draw a number $y_k$ from $\Gamma\bracket{\alpha_k,1}$.

\textbf{Step 2.} \emph{Normalize the realization.} For $k=1,\ldots,K$, set $x_k=\frac{y_k}{\sum_{\ell=1}^K y_{\ell}}$.
\end{proc}


\begin{prop}
For any $\alpha_1,\ldots,\alpha_K$ positive, \cref{proc:dirichlet:generation} produces a realization $\bracket{x_1,\ldots,x_K}$ of the Dirichlet distribution $\Dir\bracket{\alpha}$.
\end{prop}


The above procedure relies on \cref{prop:dirichlet:generation-from-gamma} proved in \cite{Devroye1986}.

\begin{prop}\label{prop:dirichlet:generation-from-gamma}
Let $\theta,\alpha_1,\ldots,\alpha_K$ be $K+1$ positive real numbers.
For $K$ independently distributed Gamma distributions
$\va y_1\sim\Gamma\bracket{\alpha_1,\theta},\ldots,\va y_K\sim\Gamma\bracket{\alpha_K,\theta}$,
we have:
\begin{subequations}
  \begin{align}
    V &= \sum_{k=1}^K \va y_k \sim \Gamma\bracket{\sum_{k=1}^K \alpha_k,\theta}
    \\
    \va x &= \bracket{\va x_1,\ldots,\va x_K} = \bracket{\frac{\va y_1}{V},\ldots,\frac{\va y_K}{V}} \sim \Dir\bracket{\alpha_1,\ldots,\alpha_K}
  \end{align}
\end{subequations}
\end{prop}

Other methods exist to generate random variables following a Dirichlet distribution.
But this one is easy to understand and to implement because C++ standard library have a gamma generator since 2011 edition.


