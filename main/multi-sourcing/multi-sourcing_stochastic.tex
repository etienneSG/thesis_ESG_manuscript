%!TEX root=../../thesis_ESG.tex
\chapter{Stochastic multi-sourcing}
\label{chap:multi-sourcing:stochastic}


\section{Introduction}
\label{sec:multi-sourcing:stochastic:introduction}


\subsection{Motivations}
\label{sec:multi-sourcing:stochastic:introduction:motivations}


In \cref{chap:multi-sourcing:deterministic}, data are deterministic.
In practice, part of data is uncertain.
Indeed, multi-sourcing decisions are long-term decisions and it is unlikely that forecast demand is perfectly accurate.
As for production planning decisions, uncertainty may come from efficiency of machines (and affect time needed for the production of one item), capacities (due to breakdown, strike) or any other part of the supply chain like the procurement of raw materials.
For multi-sourcing decisions, Argon Consulting has identified uncertainty on forecast demand as the main issue for its clients.
Since multi-sourcing problem addresses the question of flexibility (see \cref{chap:business-context}), the relevant uncertainty comes from variation in the product mix and not from variations of global volume of demand nor from other sources.


Dealing with uncertainty leads to consider possible unsatisfied demand.
Methods to face uncertainty goes from the more conservative which does not allow stock-out in any outcome to methods controlling stock-out probability, stock-out quantity or other relevant indicators.
Discussions with Argon Consulting raise two characteristics of unsatisfied demand.
First, multi-sourcing decisions should lead to ``high long term service level''.
Indeed, multi-sourcing decisions take time to be implemented.
Thus, service level on the first periods can be low due to augmentation of capabilities and should be less relevant than service level in steady state.
The measure used for service level should not be too sensitive to sparse failure at the beginning.
Second, worst cases must be ``not too bad''.
Multi-sourcing decisions are long-term decisions which impact the company competitiveness for long periods since cannot be easily changed.
Thus, while remaining not too expensive, multi-sourcing decisions should be efficient enough to control the loss when bad outcomes occur.
%Thus, when making service level decisions, optimization should take into account worst cases and not just optimize good ones.


These two characteristics are not easy to take into account.
Several approaches are possible and will be discussed in \cref{sec:multi-sourcing:stochastic:discussion}.



\subsection{Problem statement}
\label{sec:multi-sourcing:stochastic:introduction:problem-statement}


For the sake of completeness, we present the problem in full details but it is very close to the deterministic one.
We consider a set $\plants$ of plants producing a set $\REF$ of items over $\horizon$ periods.
There is an upper bound $\capacity_{pt}$ on the total period production of plant $p$ at period $t$ (summed over all items).
This upper bound is expressed in time unit since it correspond to available working hours.


Giving a plant $p$ the ability to produce an item $i$ has a cost $\affect_p^i$.
This cost is paid once and for all for the whole horizon.
When a plant $p$ is able to produce item $i$, there is an upper (resp. lower) bound $\ub_{pt}^i\ge 0$ (resp. $\lb_{pt}^i\ge 0$) on the production of item $i$ in plant $p$ at period $t$.
The capacity needed (in time units) to produce one unit of item $i$ in plant $p$ in period $t$ is $\rate_{pt}^i>0$.
For each item $i$, the average value of $\rate_{pt}^i$ over plants and periods is denoted $\rate^i$.


The production must satisfy a random demand as well as possible.
However, because of uncertainty, backorder (\ie late delivery) is allowed.
We introduce a parameter $\servicelvl\in\bracket{0,1}$ which controls the part of demand delivered on time.
It first defines the proportion of cases for which demand has to be satisfied.
Second, in the remaining cases (\ie the ``worst cases''), the expectation of the sum of inventory and backorder must be nonnegative.


The demand of item $i$ over period $t$ is a random parameter $\va\demand_t^i$, whose realization is known at the end of period $t$.
When production of an item $i$ (summed over all plants) is not used to satisfy the demand, it can be stored and incurs no cost.
For each item $i$, there is an initial inventory $\inventory_0^i\in\RR_+$.


Regarding randomness, we assume that for any $i$ and $t$, realizations of $\bracket{\va\demand_t^i,\ldots,\va\demand_{\horizon}^i}$ have finite expectation and can be efficiently sampled, knowing a realization of $\bracket{\va\demand_1^j,\ldots,\va\demand_{t-1}^j}_{j\in\REF}$.
Multi-sourcing decisions are made before knowing any realizations of the demand.
Production decisions can be made at the beginning of each period knowing past realizations of the demand.
This kind of formulation is called \emph{multi-stage}.


The goal is to satisfy the service level constraint at minimum cost.


We call this problem the \emph{stochastic multi-sourcing problem}.


\subsection{Main results}
\label{sec:multi-sourcing:stochastic:introduction:main-results}


We propose a model for the stochastic multi-sourcing problem in \cref{sec:multi-sourcing:stochastic:model-formulation} using the \emph{Average Value at Risk $\AVaR$}.
In \cref{sec:multi-sourcing:stochastic:solving-method}, we develop a method to solve it by linearizing the $\AVaR$ and a heuristic to speed up the resolution on big dataset.
In \cref{sec:multi-sourcing:stochastic:discussion}, we discuss the choices made to model the uncertainty.



\section{Bibliography}
\label{sec:multi-sourcing:stochastic:bibliography}


Deciding multi-sourcing is a long term decision and often comes with stochastic considerations.
A extensive review is proposed by \citet{Yao2017}.


A seminal model about stochastic multi-sourcing is given by \citet{Jordan1995}.
In automotive industry, they aim at deciding which plant (or which line) should have the ability to produce each item.
This is a single-period model which aims at minimizing the shortfall subject to limited flexibility.
As in the deterministic case, they conclude that a long chain configuration enables to have results almost as good as a complete flexibility.
A similar model is proposed by \citet{Brian2005} that consider risk-neutral and risk averse objective.
In order to deal with more complicated cases (multi-item and multi-market), \citet{Garavelli2003} uses simulations to quantify impact of flexibility configurations.
Again, a limited flexibility seems sufficient to achieve very good results.


One goal of stochastic multi-sourcing is to deal with risk.
In literature, production, ordering or multi-sourcing problems taking risk into account are often single-item problem.
Risk aversion extension of news-vendor problem was extensively studied (see \citet{Vipul2000} and \citet{Choi2008}).
More recently, \citet{Arikan2017} propose a classification of existing extensions (included those with Average-Value-at-Risk).
\citet{Ahmed2007} are one of the rare authors using coherent risk measure for a multi-period inventory problem.
Their objective is to minimize a risk averse function (like $\AVaR$) instead of a risk neutral function (like expectation).
However, these are production decisions and not multi-sourcing decisions.


A single-item single-period multi-sourcing problem is also addressed in \citet{Meena2011}.
In this paper, each supplier has a different rate of failure (\ie to not produce anything) but demand is equally divided between suppliers.
They studied different cases and in particular, the minimization of the expected total cost for a pre-determined service level.




\section{Model formulation}
\label{sec:multi-sourcing:stochastic:model-formulation}


To model the constraint on the backorder, we first introduce the Average Value at Risk and then present the model.
Choices made to model the risk will be discussed in \cref{sec:multi-sourcing:stochastic:discussion}.


\subsection{Average Value at Risk}


In order to measure and control the service level, we use the \emph{Average Value at Risk ($\AVaR$)} which is a \emph{coherent risk measure} widely studied (see for example \citet{Artzner1999,Rockafellar2000,Rockafellar2002}) and chose the definition given in \citet{Follmer2004}.
In financial context, risk measures are used to quantify the risk of a position.


Fix some level $\lambda\in\bracket{0,1}$. For a random variable $\va X:\scenarios\to\RR$, its \emph{Value at Risk at level $\lambda$} is defined as
\begin{equation}
\VaR_{\lambda}\bracket{\va X} = \inf\sqbracket{m\in\RR\left|\prob\crbracket{\va X+m<0}\le\lambda\right.}.
\end{equation}


For the inventory, $\VaR_{1-\servicelvl}\bracket{\va\inventory}$ might correspond to the safety stock in the case of a cycle service level $\servicelvl$.
More precisely, adding this quantity to the inventory keeps the probability of a stock-out below $1-\servicelvl$.
The main drawback of the Value at Risk is that it only controls the probability of a stock-out and not its size.
Thus, we use the following coherent risk measure defined from the Value at Risk.


Fix some level $\lambda\in\bracket{0,1}$. For a random variable $\va X:\scenarios\to\RR$, its \emph{Average Value at Risk at level $\lambda$} is defined as
\begin{equation}
\AVaR_{\lambda}\bracket{\va X} = \frac{1}{\lambda}\int_0^{\lambda}\VaR_{\gamma}\bracket{\va X}\diff\gamma.
\end{equation}


For the inventory, $\AVaR_{1-\servicelvl}\bracket{\va\inventory}$ seems like the safety stock in the case of a fill rate service level $\servicelvl$.
More precisely, $\AVaR_{1-\servicelvl}\bracket{\va\inventory}\le 0$ means that the average of safety stocks needed to ensure cycle service level from $\servicelvl$ to 1 is negative (\ie no safety stocks is required).


\cref{fig:avar-examples} represents the Value at Risk and the Average Value at Risk in the case of a Gaussian distribution of the stock $\va\inventory_t^i$.


\begin{figure}[h]
  \centering
  \includegraphics{main/multi-sourcing/images/avar-example.tikz}
  \caption{Example of risk measures for the inventory}
  \label{fig:avar-examples}
\end{figure}



\subsection{Model}


In order to solve the stochastic multi-sourcing problem, we introduce the following decision variables.
The quantity of item $i$ produced at period $t$ by plant $p$ is denoted by $\va\quantity_{pt}^i$ and the inventory at the end of the period is denoted by $\va\inventory_t^i$ .
We also introduce a binary variable $\open_p^t$ which takes the value 1 if plant $p$ is given the ability to produce item $i$.
All these variables are random and may depend on the past realizations of the random demand $\bracket{\va\demand_1^j,\ldots,\va\demand_{t-1}^j}_{j\in\REF}$.


We model the stochastic multi-sourcing problem as
\begin{subequations}\label{eq:stoch-multi-sourcing}
  \begin{align+}
    \min\quad & \rlap{$\ds \sum_{i\in\REF}\sum_{p\in\plants}\affect_p^i \open_p^i$}
    \label{eq:stoch-multi-sourcing:objective}
    \\
    \st\quad & \ds \va\inventory_t^i = \va\inventory_{t-1}^i + \sum_{p\in\plants}\va\quantity_{pt}^i - \va\demand_t^i && \forall t\in\range{\horizon},\ \forall i\in\REF,
    \label{eq:stoch-multi-sourcing:inventory-dynamic}
    \\
    & \ds \sum_{i\in\REF}\rate_{pt}^i\va\quantity_{pt}^i \leq \capacity_{pt} && \forall t\in\range{\horizon},\ \forall p\in\plants,
    \label{eq:stoch-multi-sourcing:capacity}
    \\
    & \ds \lb_{pt}^i \open_p^i \le \rate_{pt}^i\va\quantity_{pt}^i \le \ub_{pt}^i \open_p^i && \forall t\in\range{\horizon},\ \forall p\in\plants, \forall i\in\REF,
    \label{eq:stoch-multi-sourcing:big-M}
    \\
    & \AVaR_{1-\servicelvl}\bracket{\va\inventory_t^i} \le 0 && \forall t\in\range{\horizon},\ \forall i\in\REF,
    \label{eq:stoch-multi-sourcing:AVaR}
    \\
    & \ds \open_p^i \in \crbracket{0,1} && \forall p\in\plants,\ \forall i\in\REF,
    \label{eq:stoch-multi-sourcing:boolean}
    \\
    & \ds  \va\quantity_{pt}^i\ \mbox{is}\ \Sfield{\bracket{\va\demand_1^i,\ldots,\va\demand_{t-1}^i}_{i\in\REF}}\mbox{--measurable} && \forall t\in\range{\horizon},\  \forall p\in\plants,\ \forall i\in\REF.
    \label{eq:stoch-multi-sourcing:measurability}
  \end{align+}
\end{subequations}


Objective~\eqref{eq:stoch-multi-sourcing:objective} still minimizes the assignment costs.
Constraints~\eqref{eq:stoch-multi-sourcing:inventory-dynamic}, \eqref{eq:stoch-multi-sourcing:capacity}, \eqref{eq:stoch-multi-sourcing:big-M} have the same meaning than their deterministic counterpart.
Constraint~\eqref{eq:stoch-multi-sourcing:AVaR} enables to control the service level using Average Value at Risk.
It will be discussed in \cref{sec:multi-sourcing:stochastic:model:discussion}.
Last constraint~\eqref{eq:stoch-multi-sourcing:measurability} of the program, written as a {\em measurability constraint}, means that the values of the variables $\va\quantity_{pt}^i$ can only depend on the values taken by the demand before time $t$ (the decision maker does not know the future).
Every constraints of the problem, except the Average Value at Risk constraint~\eqref{eq:stoch-multi-sourcing:AVaR}, hold almost surely.




\section{Solving method and theoretical results}
\label{sec:multi-sourcing:stochastic:solving-method}


Due to the obvious hardness of program~\eqref{eq:stoch-multi-sourcing}, we turn to an approximate method.


\subsection{Linearization of $\AVaR$}
\label{sec:multi-sourcing:stochastic:avar-linearization}


Linearization of $\AVaR$ constraint can be efficiently made in case of a finite probability space $\Omega$.
\cref{lem:linearize-AVaR}, based on results by \citet{Rockafellar2000}, gives the complete definition of the polyhedron defined by $\AVaR$ constraint in case of a finite probability space.


\begin{lem}\label{lem:linearize-AVaR}
For a random variable $\va X$ taking its values at random in a finite set $\{X_{\omega}\colon\omega\in\Omega\}$ with probability $\{p_{\omega}\colon\omega\in\Omega\}$ and for $\lambda\in\bracket{0,1}$, the inequality 
$\AVaR_{\lambda}\bracket{\va X} \le 0$ holds if and only if the following polyhedron is nonempty:
$$
\left\{
\bracket{\alpha,m}\in\RR_+^{\Omega}\times\RR
\;\left|\;
\frac{1}{\card{\Omega}}\sum_{\omega\in\Omega}p_{\omega}\alpha_{\omega}\leq \lambda m
\quad\mbox{\textup{and}}\quad
\alpha_{\omega}\geq m-X_{\omega}\;
\mbox{\textup{for all}}\;\omega\in\Omega
\right.
\right\}.
$$
\end{lem}


\begin{proof}
We have the following equivalences.
\begin{subequations}
  \begin{align+}
    \ds\AVaR_{\lambda}\bracket{\va X} \le 0 &\ds\iff \frac{1}{\lambda} \inf_{m\in\RR}\bracket{\espe\sqbracket{\bracket{m-\va X}^+}-\lambda m} \le 0
    \label{eq:follmer-and-schied-proposition}
    \\
    &\ds\iff \frac{1}{\lambda} \inf_{m\in\RR}\bracket{\sum_{\omega\in\Omega}p_{\omega}\bracket{m-X_{\omega}}^+ - \lambda m} \le 0
    \label{eq:discrete-space probability}
    \\
    &\ds\iff \exists m\in\RR \colon\; \frac{1}{\lambda}    \bracket{ \sum_{\omega\in\Omega}p_{\omega}\bracket{m-X_{\omega} }^+ - \lambda m} \le 0
    \\
    &\ds\iff \exists \bracket{\alpha,m}\in\RR_+^{\Omega}\times\RR\colon\;
    \left\{
      \begin{array}{l}
        \ds\frac{1}{\lambda}\bracket{\sum_{\omega\in\Omega}p_{\omega}\alpha_{\omega}-\lambda m} \le 0 \\
        \ds\alpha_{\omega}\ge m-X_{\omega},\ \forall\omega\in\Omega
      \end{array}
    \right.
  \end{align+}
\end{subequations}
Equivalence~\eqref{eq:follmer-and-schied-proposition} is given by Proposition~4.37 in \citet{Follmer2004}.
Equivalence~\eqref{eq:discrete-space probability} comes from the finite space probability.
\end{proof}


\subsection{Solving method}
\label{sec:multi-sourcing:stochastic:solving-method:solving-method}


As shown in \cref{sec:multi-sourcing:deterministic:NP-completeness}, deterministic multi-sourcing problem is hard.
Therefore, we cannot expect a quick algorithm solving exactly the problem, and this holds especially for the full stochastic version.
Like stochastic production planning problems (see \cref{part:production planning}), stochastic multi-sourcing problems are hard to solve.


We use the same approximation method than for solving Stochastic CLSP-BS (see \cref{sec:PDP:stochastic:solving-method:solving-method}).
We propose a two-stage approximation consisting in replacing the measurability constraint~\eqref{eq:stoch-multi-sourcing:measurability} by
\begin{equation}
\va\quantity_{pt}^i\ \mbox{is}\ \Sfield{\bracket{\va\demand_1^i,\ldots,\va\demand_{\horizon}^i}_{i\in\REF}}\mbox{--measurable} \quad \forall t\in\range{\horizon},\ \forall i\in\REF
\end{equation}
which provides a relaxation of the initial program: the assignment decisions can still not depend on the future, but now the production decisions depend on the future demand.
(Relaxing the measurability constraint means that once the $\open_p^r$ has been chosen, the demand over the whole horizon is supposed to be revealed.)
We denote this relaxation by (2SA).


This approximation is a \emph{two-stage approximation} as we distinguish between two levels of information over the uncertainty: assignment decisions are the \emph{first stage} variables, while all other decisions are \emph{second stage} variables.


The (2SA) relaxation is then solved by a classical {\em sample average approximation} (see~\citet{Kleywegt2002} for a presentation of the method).
We build a set $\scenarios$ of $m$ scenarios sampled uniformly at random.
Each of these scenarios is a possible realization of $(\va\demand_1^i,\ldots,\va\demand_{\horizon}^i)$ for each item $i$.
The parameter $m$ is fixed prior to the resolution.


In order to linearize $\AVaR$ constraint \eqref{eq:stoch-multi-sourcing:AVaR}, we introduce for each period $t$ and each item $i$ auxiliary variables $m_t^i\in\RR$ and $\bracket{\alpha_{t,\omega}^i}_{\omega}\in\RR_+^{\scenarios}$.
Thanks to \cref{lem:linearize-AVaR}, we get the following mixed integer program (2SA-$m$).
\begin{subequations}\label{eq:stoch-multi-sourcing:linearized}
  \begin{align+}
    \min\quad & \rlap{$\ds \sum_{i\in\REF}\sum_{p\in\plants}\affect_p^i \open_p^i$}
    \label{eq:stoch-multi-sourcing:linearized:objective}
    \\
    \st\quad & \ds \inventory_{t,\omega}^i = \inventory_{t-1,\omega}^i + \sum_{p\in\plants}\quantity_{pt,\omega}^i - \demand_{t,\omega}^i && \forall\omega\in\scenarios,\ \forall t\in\range{\horizon},\ \forall i\in\REF,
    \label{eq:stoch-multi-sourcing:linearized:inventory-dynamic}
    \\
    & \ds \sum_{i\in\REF}\rate_{pt}^i\quantity_{pt,\omega}^i \leq \capacity_{pt} && \forall\omega\in\scenarios,\ \forall t\in\range{\horizon},\ \forall p\in\plants,
    \label{eq:stoch-multi-sourcing:linearized:capacity}
    \\
    & \ds \lb_{pt}^i \open_p^i \le \rate_{pt}^i\quantity_{pt,\omega}^i \le \ub_{pt}^i \open_p^i && \forall\omega\in\scenarios,\ \forall t\in\range{\horizon},\ \forall p\in\plants, \forall i\in\REF,
    \label{eq:stoch-multi-sourcing:linearized:big-M}
    \\
    & \frac{1}{\card{\Omega}}\sum_{\omega\in\Omega}\alpha_{t,\omega}^i\leq (1-\beta)m_t^i && \forall t\in\range{\horizon},\ \forall i\in\REF,
    \label{eq:stoch-multi-sourcing:linearized:AVaR:1}
    \\
    & \alpha_{t,\omega}^i\geq m_t^i-s_{t,\omega}^i && \forall\omega\in\scenarios,\ \forall t\in\range{\horizon},\ \forall i\in\REF,
    \label{eq:stoch-multi-sourcing:linearized:AVaR:2}
    \\
    & \ds \quantity_{pt,\omega}^i,\ \alpha_{t,\omega}^i \ge 0 && \forall\omega\in\scenarios,\ \forall t\in\range{\horizon},\ \forall i\in\REF,
    \label{eq:stoch-multi-sourcing:linearized:positivity}
    \\
    & \ds \open_p^i \in \crbracket{0,1} && \forall p\in\plants, \forall i\in\REF.
    \label{eq:stoch-multi-sourcing:linearized:boolean}
  \end{align+}
\end{subequations}
This mixed-integer program can be solved by any linear solver for small dataset but needs heuristics or decomposition methods for big dataset.


\subsection{Heuristic to solve mixed integer program~\eqref{eq:stoch-multi-sourcing:linearized}}


When working on big dataset, LP solver are unable to find feasible solutions (see \cref{sec:multi-sourcing:numerical-experiments:numerical-results}).
Thus, we propose a simple heuristic to find a solution in reasonable time.


As explained in \cref{chap:business-context}, randomness comes from the variations of product mix and not from the global volume which is assumed constant.
The basic idea of the heuristic is to scale the demand of every item at every period with a factor $\alpha\ge1$ and to solve the deterministic version~\eqref{eq:det-multi-sourcing} got with this demand.
Then, the obtained assignment should be feasible for $\alpha$ large enough.


The details of the heuristic are given by Algorithm~\ref{alg:multi-sourcing:MIP:heuristic}.
It has two parameters:
\begin{itemize}
  \item $N$ which is the number of values tried for $\alpha$,
  \item $\tau$ which is the time limit to solve the program (P) with its demand scaled by $\alpha$.
\end{itemize}
% We denote by $W$ the cumulative sum of working hours which is assumed constant over every scenarios and is equal to $\sum_{i\in\REF}\sum_{t=1}^{\horizon}\rate^i\demand_t^i$ and by $\capacity$ the cumulative capacity of plants over periods which is equal to $\sum_{p\in\plants}\sum_{t=1}^{\horizon}\capacity_{pt}$.


\begin{algorithm}[H]
\Input{Mixed integer program~\eqref{eq:stoch-multi-sourcing:linearized}, expected demand $\espe\sqbracket{\va\demand_t^i}$ for all period $t$ and all item $i$}
\Output{Multi-sourcing $\bracket{\open_p^i}_{p,i}$}
\Parameters{$N$, $\tau$}

\BlankLine

Set cost of current multi-sourcing $\bracket{\open_p^i}_{p,i}$ equal to $+\infty$.

\BlankLine

Construct program (P) which is deterministic version~\eqref{eq:det-multi-sourcing} with:\;
\begin{itemize}
  \item demand $\demand_t^i=\espe\sqbracket{\va\demand_t^i}$ for all period $t$ and all item $i$,
  \item every other parameters of (P) are equal to those of mixed integer program~\eqref{eq:stoch-multi-sourcing:linearized}.\;
\end{itemize}
Set $W=\sum_{i\in\REF}\sum_{t=1}^{\horizon}\rate^i\espe\sqbracket{\va\demand_t^i}$. \tcp*[r]{cumulative sum of working hours}
Set $\capacity=\sum_{p\in\plants}\sum_{t=1}^{\horizon}\capacity_{pt}$. \tcp*[r]{cumulative capacity of plants}

\BlankLine

\BinarySearch{\em $\alpha$ \Between 1 \And $\frac{\capacity}{W}$\hfill\textnormal{\texttt{// $N$ iterations}}}
{
  Construct program (P$_{\alpha}$) from program (P) by replacing demand $\demand_t^i$ by $\alpha\demand_t^i$.\;
%   Uniformly scale demand by $\alpha$\;
  Solve program (P$_{\alpha}$). \tcp*[r]{time limit = $\tau$}
  \eIf{\em program (P$_{\alpha}$) is infeasible,}
  {
    Decrease $\alpha$.\;
  }
  {
    Let $\bracket{\tilde{\open}_p^i}_{p,i}$ be the solution of program (P$_{\alpha}$).\;
    Solve mixed integer program~\eqref{eq:stoch-multi-sourcing:linearized} with assignment $\bracket{\tilde{\open}_p^i}_{p,i}$.\;
    \eIf{\em mixed integer program~\eqref{eq:stoch-multi-sourcing:linearized} with assignment $\bracket{\tilde{\open}_p^i}_{p,i}$ is infeasible,}
    {
      Increase $\alpha$.\;
    }
    {
      \If{\em cost of new multi-sourcing $\bracket{\tilde{\open}_p^i}_{p,i}$ is lower than cost of current one $\bracket{\open_p^i}_{p,i}$,}
      {
        Replace current multi-sourcing $\bracket{\open_p^i}_{p,i}$ by new one $\bracket{\tilde{\open}_p^i}_{p,i}$.\;
      }
      Decrease $\alpha$.\;
    }
  }
}

\Return current multi-sourcing $\bracket{\open_p^i}_{p,i}$.\;

\BlankLine
\caption{Heuristic to solve mixed integer program~\eqref{eq:stoch-multi-sourcing:linearized}}
\label{alg:multi-sourcing:MIP:heuristic}
\end{algorithm}


Solving program (P) with a higher demand enables to find a multi-sourcing which faces an augmentation of the demand of every items.
In practice, it is too conservative since not every demand can increase in the same scenario (the cumulative sum of working hours is constant).
For the binary search, the upper bound on $\alpha$ is chosen equal $\frac{W}{C}$ where $W$ is the cumulative sum of working hours which is assumed constant over every scenarios and $\capacity$ is the cumulative capacity of plants over periods.
Scaling the demand by $\frac{W}{C}$ gives a model where capacity is almost equal to working hours needed to satisfy demand.
Thus, every $\alpha$ greater than $\frac{W}{C}$ is unlikely to produce a feasible program.
The lower bound on $\alpha$ is chosen equal to 1.
If we cannot satisfy the demand in the case where it is equal to its expectation, then program~\eqref{eq:stoch-multi-sourcing:linearized} is likely to be infeasible.


A binary search algorithm on $\alpha$ is justified by the monotony of optimal values of program (P$_{\alpha}$) (\ie program (P) with demand scaled by $\alpha$).
% Indeed, for $\alpha_1$ and $\alpha_2$ in $\bracket{1,\frac{W}{C}}$, the cost of an optimal solution of program (P$_{\alpha_1}$) is lower or equal to the cost of an optimal solution of program (P) with demand scaled by $\alpha_2$.
Proving it is straightforward.
Let $\alpha_1$ and $\alpha_2$ be two positive real numbers such that $\alpha_1\le\alpha_2$. If program (P$_{\alpha_2}$) has an optimal solution, this solution is also a solution of program (P$_{\alpha_1}$) and has the same cost.
In Algorithm~\ref{alg:multi-sourcing:MIP:heuristic}, the condition comparing the value of current multi-sourcing to the value of the new one is necessary in the case where the solver has not enough time to find the optimal solution of program (P).
That is why, finding the smallest $\alpha$ such that (P$_{\alpha}$) is feasible and such that mixed integer program~\eqref{eq:stoch-multi-sourcing:linearized} with assignment equal to the optimal solution of (P$_{\alpha}$) is feasible gives the best assignment that the heuristic can return.


However, the set of $\alpha$ such that (P$_{\alpha}$) is feasible and such that mixed integer program~\eqref{eq:stoch-multi-sourcing:linearized} with assignment equal to the optimal solution $\bracket{\open_p^i(\alpha)}_{p,i}$ of (P$_{\alpha}$) is not an interval.
Consider the following example.
We have two items, two plants with capacities $\capacity_1=100$ and $\capacity_2=55$, and one period and 2 scenarios with same probability.
The parameter $\servicelvl$ is chosen equal to $100\%$ preventing from any stock-out.
The other parameters of the multi-sourcing problem are given in \cref{tab:multi-sourcing:heuristic:counterexample:data}.
\begin{table}[h]
\subfloat[Assignment costs $\affect_p^i$]
{\begin{tabular}{@{\extracolsep{\fill}}lcc@{\extracolsep{\fill}}}
\cline{2-3}
       & plant 1 & plant 2 \\
\hline
item 1 & 1       & 20 \\
item 2 & 1       & 10 \\
\hline
\end{tabular}}
\hfill
\subfloat[Demand $\demand_{1,\omega}^i$]
{\begin{tabular}{@{\extracolsep{\fill}}lcc@{\extracolsep{\fill}}}
\cline{2-3}
       & scenario 1 & scenario 2 \\
\hline
item 1 & 60         & 40 \\
item 2 & 40         & 60 \\
\hline
\end{tabular}}
\hfill
\subfloat[Other parameters]
{\begin{tabular}{p{2cm}lp{2cm}}
& $\rate_{p,1}^i = 1$   & \\
& $\lb_{p,1}^i   = 0$   & \\
& $\ub_{p,1}^i   = 100$ & \\
\end{tabular}}
\caption{Parameters of the counterexample}
\label{tab:multi-sourcing:heuristic:counterexample:data}
\end{table}

As shown in \cref{tab:multi-sourcing:heuristic:counterexample:results}, program (P$_{\alpha}$) is feasible for $\alpha\in\crbracket{1,1.1,1.2}$. However, if mixed integer program~\eqref{eq:stoch-multi-sourcing:linearized} with the optimal assignments of (P$_{1}$) and of (P$_{1.2}$) is feasible, it is infeasible with the optimal assignments of (P$_{1}$).

\begin{table}[h]
\begin{tabular*}{\linewidth}{@{\extracolsep{\fill}}lccc@{\extracolsep{\fill}}}
\cline{2-4}
&
Optimal assignment of (P$_{\alpha}$)
&
Cost
&
Feasible MIP~\eqref{eq:stoch-multi-sourcing:linearized}
\\ \hline
$\alpha=1$
&
\begin{tabular}{@{\extracolsep{\fill}}lcc@{\extracolsep{\fill}}}
       & plant 1 & plant 2 \\
\hline
item 1 & 1       & 0 \\
item 2 & 1       & 0
\end{tabular}
&
2
&
true
\\ \hline
$\alpha=1.1$
&
\begin{tabular}{@{\extracolsep{\fill}}lcc@{\extracolsep{\fill}}}
       & plant 1 & plant 2 \\
\hline
item 1 & 1       & 0 \\
item 2 & 0       & 1
\end{tabular}
&
11
&
false
\\ \hline
$\alpha=1.2$
&
\begin{tabular}{@{\extracolsep{\fill}}lcc@{\extracolsep{\fill}}}
       & plant 1 & plant 2 \\
\hline
item 1 & 1       & 0 \\
item 2 & 1       & 1
\end{tabular}
&
12
&
true
\\ \hline
\end{tabular*}
\caption{Solutions returned by an iteration of Algorithm~\ref{alg:multi-sourcing:MIP:heuristic} for $\alpha\in\crbracket{1,1.1,1.2}$}
\label{tab:multi-sourcing:heuristic:counterexample:results}
\end{table}
\renewcommand{\arraystretch}{1}



\subsection{Bender decomposition}


Formulation \eqref{eq:stoch-multi-sourcing:linearized} has a structure which fit with Bender decomposition.
%\vlil{En fait c'est faux tel quel car il y a la contraintes de risques qui lie les différents scénarios. Dans ta matrices 9.8 il faut donc rajouter une ligne couplante, et se contenter de parler de Bender et non de L-Shaped, contrairement à ce que j'avais dis...}
We refer to \citet[Chapter 5]{Birge2011} for a presentation of the method.
Indeed, introducing the vector $z$ of first-step variables (assignment variables $(\open_p^i)_{p,i}$ and auxiliary variables $(m_t^i)_{t,i}$) and for each scenario $\omega$, the vector $w_{\omega}$ of second-step variables (inventory variables $(\inventory_{t,\omega}^i)_{t,i,\omega}$, production variables $(\quantity_{pt,\omega}^i)_{p,t,i}$ and auxiliary variables $(\alpha_{t,\omega}^i)_{t,i,\omega}$, we get the following program
\begin{subequations}\label{eq:stoch-multi-sourcing:bender}
  \begin{align+}
    \min\quad & \rlap{$\ds f\bracket{z}$}
    \label{eq:stoch-multi-sourcing:bender:objective}
    \\
    \st\quad & A\bracket{z, u} = a && \forall\omega\in\scenarios,
    \label{eq:stoch-multi-sourcing:bender:avar}
    \\
    & T z + W u_{\omega} = h_{\omega} && \forall\omega\in\scenarios,
    \label{eq:stoch-multi-sourcing:bender:constraint}
    \\
    & \ds z\in \cZ.
    \label{eq:stoch-multi-sourcing:bender:first-step}
  \end{align+}
\end{subequations}
where
constraint~\eqref{eq:stoch-multi-sourcing:bender:avar} is the coupling constraint~\eqref{eq:stoch-multi-sourcing:linearized:AVaR:1},
constraint~\eqref{eq:stoch-multi-sourcing:bender:constraint} regroups constraints~\eqref{eq:stoch-multi-sourcing:linearized:inventory-dynamic}, \eqref{eq:stoch-multi-sourcing:linearized:capacity}, \eqref{eq:stoch-multi-sourcing:linearized:big-M}, \eqref{eq:stoch-multi-sourcing:linearized:AVaR:2} and \eqref{eq:stoch-multi-sourcing:linearized:positivity}
and $\cZ$ is binary constraint on part of first-step variables.
Thus, the constraints have the following block structure.
         
\begin{equation}
\left(
\begin{array}{ccccc}
\hline
\multicolumn{5}{|c|}{A}
\\\hline
T           & W           &   & \multicolumn{2}{c}{\multirow{2}{*}{$\bracket{0}$}} \\               
T           &             & W &        & \\
\vdots      & \multicolumn{2}{c}{\multirow{2}{*}{$\bracket{0}$}} & \ddots & \\
T           & & & & W \\
\end{array}
\right)
\end{equation}


We did not have the time to implement this method, but it is promising to accelerate resolution of formulation~\eqref{eq:stoch-multi-sourcing:linearized}.



\section{Discussion on expectation, robust, probabilistic and average value at risk constraints}
\label{sec:multi-sourcing:stochastic:discussion}


As explained in \cref{sec:multi-sourcing:stochastic:introduction:motivations}, multi-sourcing decision must lead to ``high long term service level'' and to good control on ``worst cases''.
These constrains are ill-defined.
Many way of modeling them are possible.
We choose to use the Average Value at Risk and compare its pros and cons to the ones of expectation, robust and probabilistic constraints.


In the case of multi-sourcing problem, these three constraints are defined as follow.
For each item $i$ and each period $t$, the expectation constraint on the inventory $\va\inventory_t^i$ is written as ``$\espe\sqbracket{\va\inventory_t^i}\ge0$'', the probabilistic constraint as ``$\prob\sqbracket{\va\inventory_t^i\ge0}\ge\servicelvl$'' and the robust constraint as ``$\va\inventory_t^i\ge0$, almost surely''.
Note that we consider a simple case of robust constraint which is an extreme case of probabilistic and $\AVaR$ constraint with $\servicelvl=1$.




\subsection{Small example}
\label{sec:multi-sourcing:stochastic:discussion:small-example}


To illustrate discussions about the different constraints, we propose the following example.
Consider a company producing a single item for one period.
Consider that the company may open up to 4 identical plants to produce the item and when it opens one, it must use its full capacity which is equal to 100.
The random demand for the item is uniformly drawn in $\crbracket{50,100,200,250,350}$ and the parameter $\servicelvl$ to control the service level is equal to $60\%$.
Opening a plant (\ie assigning the item to a plant) has a unit cost.
The parameters of the multi-sourcing problem are then set as follow
$$
  \horizon=1
  ,\quad
  \plants=\range[1]{4}
  ,\quad
  \REF=\crbracket{1}
  ,\quad
  \va\demand_1^i\sim\cU\crbracket{50,100,200,250,350}
  ,\quad
  \servicelvl=60\%,
$$
$$
  \affect_p^i=1
  ,\quad
  \rate_{p,1}^i=1
  ,\quad
  \lb_{p,1}^i=\ub_{p,1}^i=\capacity_{p,1}=100.
$$
Since the plants are identical, we simply use the number of open plants as a decision variable and denote by $\va\inventory$ the inventory at the end of the period.
\cref{tab:indicator-values-depending-on-open-plants} gives the values of the left part of each constraint depending on the number of open plants.
Orange values correspond to cases where constraint is satisfied.
The two last lines correspond to the fill rate service level and to the expected number of lost sales depending on the number of open plants.
\begin{table}[h]
  \centering
  \begin{tabular*}{\linewidth}{@{\extracolsep{\fill}}l|ccccc@{\extracolsep{\fill}}}
  \hline
  Number of open plants                         & 0 & 1 & 2 & 3 & 4 \\
  \hline
  $\espe\sqbracket{\va\inventory_t^i}$            & -190 & -90 & \textcolor{argon orange}{10} & \textcolor{argon orange}{110} & \textcolor{argon orange}{210} \\
  $\prob\sqbracket{\va\inventory_t^i\ge0}$        & 0\% & 40\% & \textcolor{argon orange}{60\%} & \textcolor{argon orange}{80\%} & \textcolor{argon orange}{100\%} \\
  $\AVaR_{1-\servicelvl}\bracket{\va\inventory}$  & 300 & 200 & 100 & \textcolor{argon orange}{0} & \textcolor{argon orange}{-100} \\
  $\va\inventory_t^i\ge0$, almost surely          & false & false & false & false & \textcolor{argon orange}{true} \\
  \hline
  Fill rate service level                         & 0\% & 64\% & 87\% & 97\% & 100\% \\
  Average lost sales                              & 190 & 100 & 40 & 10 & 0 \\
  \hline
  \end{tabular*}
  \caption{Indicator values depending the number of open plants}
  \label{tab:indicator-values-depending-on-open-plants}
\end{table}

To satisfy expectation or probabilistic constraints, the company must open at least 2 plants.
To satisfy $\AVaR$ constraint, the company must open at least 3 plants.
To satisfy robust constraint, the company must open at least 4 plants.
As expected by the theory, robust constraint is more conservative than $\AVaR$ which is more conservative than probabilistic constraint.


\subsection{Discussion}
\label{sec:multi-sourcing:stochastic:discussion:discussion}


\cref{tab:constraint-properties-comparison} summarizes the comparison between the expectation, robust, probabilistic and average value at risk constraints
\begin{table}[h]
  \centering
  \begin{tabular*}{\linewidth}{@{\extracolsep{\fill}}lcccc@{\extracolsep{\fill}}}
  \hline
  \multicolumn{1}{c}{Properties} & \multicolumn{4}{c}{Constraints} \\
  \cline{2-5}
                                         & $\AVaR$      & Expectation  & Robust       & Probabilistic \\
  \hline
%  Easy writing                           & \bulletminus & \bulletplus  & \bulletminus & \bulletminus \\ 
  Easy linearization                     & \bulletplus  & \bulletplus  & \bulletplus  & \bulletminus \\
  Easy interpretation                    & $\sim$       & \bulletminus & \bulletplus  & \bulletplus  \\
  Control proportion of worst cases      & \bulletplus  & \bulletminus & \bulletminus & \bulletplus  \\
  Control value of worst cases           & \bulletplus  & \bulletminus & \bulletplus  & \bulletminus \\
  Control increase of objective function & \bulletplus  & \bulletminus & \bulletminus & \bulletplus  \\ 
  Few feasibility issues                 & $\sim$       & \bulletplus  & \bulletminus & $\sim$       \\ 
  Computational complexity               & $\sim$       & \bulletplus  & \bulletplus  & \bulletminus \\
  \hline
  \end{tabular*}
  \caption{Comparison of constraint properties}
  \label{tab:constraint-properties-comparison}
\end{table}


% We do not pretend to state general truth but rather general trend on common cases.
% We propose eight criterion to compare the constraints.
% First, the ease to write representability of the constraint and to linearize it if needed.
% In many cases, expectation constraint is very easy to write since it is often a sum, an integral or a combination of the two.
% Moreover, it is already linear making it easy to use.
% On the other hand, probabilistic constraint is hard to write and to linearize since it may not be convex.
% Representability of robust and $\AVaR$ constraint are both not easy to write.
% \esgil{Supprimer la discussion sur la facilité de représenter la contrainte et ne garder que celle sur la linéarisation ?}
% Every possible outcome must be considered in robust case and definition of $\AVaR$ makes it hard to use.
% However, robust and $\AVaR$ constraints are convex.
% Using scenarios often enables to get linear formulation of robust constraint of reasonable size and as shown in \cref{sec:multi-sourcing:stochastic:avar-linearization}, $\AVaR$ can also be linearized.
% We do not pretend to state general truth but rather general trend on common cases.


We propose seven criterion to compare the constraints.
First, the ease to linearize the constraint if needed since enable us to use linear programming.
Expectation constraint is already linear making it easy to use.
On the other hand, probabilistic constraint may be hard to linearize since it may not be convex and thus it requires additional binary variables.
% For robust constraint, every possible outcome must be considered and definition of $\AVaR$ may make it hard to use.
Robust and $\AVaR$ constraints are convex.
Then, using scenarios often enables to get linear formulation of robust constraint of reasonable size and as shown in \cref{sec:multi-sourcing:stochastic:avar-linearization}, $\AVaR$ can also be linearized.


Interpretation of robust and probabilistic constraints are quite easy.
Robust constraint, in its vanilla form, consists in satisfying the constraint in every possible outcome.
In multi-sourcing, demand distribution is bounded.
Thus satisfying the robust constraint consists in having enough stock to satisfy the highest possible demand.
Probabilistic constraint consists in satisfying the constraint in $100\servicelvl\%$ of the cases.
In multi-sourcing, this means that in $100\servicelvl\%$ of the cases, stock is high enough to satisfy the demand but in the remaining cases demand can as well be fully, partially or not satisfied at all.
It perfectly matches with the cycle service level.
Even though expectation constraint seems easy to interpret, in practice, knowing the behavior of the mean does not give much information on the behavior of the outcomes.
For example, if the demand has a all-or-nothing distribution, expectation is far from any outcome.
More generally, as soon as variance of distribution is high, it is hard to interpret from expectation behavior.
Understanding $\AVaR$ constraint at level $\lambda\%$ is not straightforward.
However, it means that $100\bracket{1-\lambda}\%$ of cases satisfies the constraint and that the mean over the remaining cases also satisfy the constraint.
Thus, it includes the interpretations of a probabilistic constraint at $100\bracket{1-\lambda}\%$ and of an expectation constraint on the bad cases.
If there is not too many bad cases (\ie if $\lambda$ is small), we might expect a small variance in their distribution (while nothing ensure it).
Note that, for a same level, $\AVaR$ constraint is more strict than probabilistic constraint since $\AVaR$ constraint implies than probabilistic constraint is satisfied.



Thus, we easily see that $\AVaR$ constraint enables to control the proportion of bad cases and their value.
On the other extreme, expectation constraint does not control any of them.
Being very conservative, robust constraint does not enable to control the proportion of bad case: you must cover every outcome but it ensures that every outcome value satisfies the constraint.
On the other hand, probabilistic constraint enable to choose the proportion of worst case but it is done at costs of control on their value.


Another advantage of $\AVaR$ and probabilistic constraints is the possibility to choose the level of conservativeness.
Indeed, the company can easily see the price implied by the service level constraint and eventually relax partially this constraint with a single parameter.
On the other hand, there is not any way of changing the robust and expectation constraints behavior.


Feasibility issues of each of this constraints is directly linked to it level of conservativeness.
Robust constraint is the most conservative and a single very bad outcome lead to an infeasible model.
At the other extreme, expectation constraint is much more easy to satisfy.
Choice of the type of constraint for this criteria is strongly linked to the distribution of the random variable.


Finally, as expected, the flexibility offered by $\AVaR$ and probabilistic constraint leads to computational complexity.
On the other hand, expectation and robust constraint are often easier to deal with.


\medskip


We choose $\AVaR$ constraint because of its linearization properties.
Moreover, as wanted by Argon Consulting, $\AVaR$ enables to control the acceptable proportion of bad cases and their values.
For Argon Consulting, the real issue remains the computational complexity.

